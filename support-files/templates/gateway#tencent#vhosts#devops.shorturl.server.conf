server {
    listen __BK_CI_HTTP_PORT__;
    server_name __BK_CI_SHORTURL_FQDN__;

    #  ### ssl config begin ###
    #  listen __BK_CI_HTTPS_PORT__ ssl;
    #  include devops.ssl;
    #  # force https-redirects
    #  # if ($scheme = http) {
    #  #   return 301 https://$server_name$request_uri;
    #  # }
    #  ### ssl config end ###

    access_log __INSTALL_PATH__/logs/ci/nginx/devops.shorturl.access.$log_date.log devops_format;
    error_log __INSTALL_PATH__/logs/ci/nginx/devops.shorturl.error.log;

    # set域名区域
    set $devops_region "__BKCI_REGION_EXTERNAL__";

    # server的通用配置
    include server.common.conf;

    # 短连接接口的错误页面
    location = /sorry {
        root conf/static;
        try_files /404.page.html /default.html;
    }

    # 短连接接口
    location ~ ^/(.*) {
        set $access_type 'external';
        set $service 'artifactory';
        set $path $1;
        set $target '';
        set $safe 'true';

        access_by_lua_file 'conf/lua/router_srv.lua';

        # 设置proxy header的变量
        include proxy.set.header.common.conf;

        # 强制根据响应头的Content-Type
        more_set_headers "X-Content-Type-Options:nosniff";

        # 反向代理到目标ip，端口，路径和参数
        proxy_pass http://$target/api/external/url/visit/$path?$args;
    }

    # 心跳接口
    location = / {
        return 200 "请求成功";
    }
}
