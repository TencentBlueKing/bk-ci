root $static_dir_codecc;
index index.html index.htm;

# 设置默认的ico
location = /favicon.ico {
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    root /;
    rewrite .* conf/static/favicon.ico break;
}

location / {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control no-store;
    index index.html index.htm;
    try_files $uri @fallback;
}

location ~* \.(html)$ {
    include gray.conf;
    more_set_headers "Origin-Trial: __CODECC_ORIGIN_TRIAL__";
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control no-store;
    try_files $uri @fallback;
    # 匹配所有以 html结尾的请求
}

location ~* \.(js|css|ttf)$ {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control max-age=2592000;
    try_files $uri @fallback;
    # 匹配所有以 js,css或tff 结尾的请求
}

location @fallback {
    # v2.codecc.woa.com  302->  codecc.woa.com
    # https://tapd.woa.com/codecc_new/bugtrace/bugs/view?bug_id=1020455015104144477&jump_count=1
    set_by_lua_block $remove_v2 {
        if ngx.var.agent_type == "brower" and ngx.var.http_host == "v2.codecc.woa.com" then
          return "1"
        else
          return "0"
        end
    }
    if ( $remove_v2 = "1" ){
        rewrite ^/(.*) https://__CODECC_FQDN__/$1 redirect;
    }

    set_by_lua_file $use_https 'conf/lua/set/set_use_https.lua';

    if ($use_https = "1") {
        rewrite ^/(.*) https://__CODECC_FQDN__/$1 redirect;
    }

    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    more_set_headers "Origin-Trial: __CODECC_ORIGIN_TRIAL__";
    add_header Cache-Control no-store;
    rewrite .* /index.html break;
}
