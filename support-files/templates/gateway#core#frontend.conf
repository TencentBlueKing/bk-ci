  # 设置默认的ico
  location = /favicon.ico {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 重定向到默认子系统
  location = / {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    set_by_lua_file $fqdn 'conf/lua/set/set_fqdn.lua';
    add_header Cache-Control no-store;
    rewrite ^/(.*) /console/ redirect;
  }

  # 匹配所有以 .html 结尾的请求
  location ~* \.(html)$ {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control no-store;
    
    # 当前端pod返回404时，触发fallback
    error_page 404 = @fallback;
    proxy_intercept_errors on;
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 匹配所有以 .js, .css, .ttf, .ico, .png 等结尾的请求
  location ~* \.(js|css|ttf|ico|png|jpg|jpeg|gif|svg|woff|woff2)$ {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control max-age=2592000;
    
    # 当前端pod返回404时，触发fallback
    error_page 404 = @fallback;
    proxy_intercept_errors on;
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 匹配所有以 /[\w-_]+/(.*) 结尾的请求
  location ~* /([\w-_]+)/(.*)$ {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control max-age=2592000;
    
    # 当前端pod返回404时，触发fallback
    error_page 404 = @fallback;
    proxy_intercept_errors on;
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 匹配所有以 /[\w-_]+ 结尾的请求
  location ~* /([\w-_]+) {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    add_header Cache-Control max-age=2592000;
    
    # 当前端pod返回404时，触发fallback
    error_page 404 = @fallback;
    proxy_intercept_errors on;
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # fallback处理：当静态资源不存在时，返回对应子系统的index.html
  location @fallback {
    include gray.conf;
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    
    add_header Cache-Control no-store;
    
    # 从URI中提取子系统名称
    set $subsystem "console";
    if ($uri ~* ^/(\w+)) {
      set $subsystem $1;
    }
    
    # 重写为对应子系统的index.html并转发到前端pod
    rewrite ^(.*)$ /$subsystem/index.html break;
    
    proxy_pass http://__BK_CI_FRONTEND_HOST__:__BK_CI_FRONTEND_PORT__;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
