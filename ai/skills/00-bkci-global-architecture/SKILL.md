---
name: 00-bkci-global-architecture
description: BK-CI å…¨å±€æ¶æ„æŒ‡å—ï¼Œä»¥æµæ°´çº¿ä¸ºæ ¸å¿ƒçš„æ¨¡å—åä½œå…¨æ™¯å›¾ï¼Œæ¶µç›–å®Œæ•´æ‰§è¡Œæµç¨‹ã€æ¨¡å—ä¾èµ–å…³ç³»ã€æ•°æ®æµå‘ã€æ ¸å¿ƒæ¦‚å¿µã€‚å½“ç”¨æˆ·éœ€è¦ç†è§£ç³»ç»Ÿæ¶æ„ã€è¿›è¡Œè·¨æ¨¡å—å¼€å‘ã€äº†è§£æ¨¡å—é—´åä½œæˆ–è§„åˆ’æ¶æ„è®¾è®¡æ—¶ä¼˜å…ˆé˜…è¯»ã€‚
# ç»“æ„åŒ–å…ƒæ•°æ®ï¼ˆæ”¯æŒæ™ºèƒ½å‹ç¼©å’Œæ¸è¿›å¼åŠ è½½ï¼‰
core_modules:
  - Process (æµæ°´çº¿æ ¸å¿ƒ)
  - Auth (æƒé™è®¤è¯)
  - Project (é¡¹ç›®ç®¡ç†)
  - Store (ç ”å‘å•†åº—)
  - Dispatch (æ„å»ºè°ƒåº¦)
related_skills:
  - 29-process-module-architecture
  - 30-auth-module-architecture
  - 35-dispatch-module-architecture
  - 42-worker-module-architecture
  - 43-agent-module-architecture
token_estimate: 45000
---

# BK-CI å…¨å±€æ¶æ„æŒ‡å—

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸš€ å¿«é€Ÿå‚è€ƒåŒºï¼ˆæ”¾åœ¨æœ€å‰é¢ - è§£å†³ Lost-in-Middle é—®é¢˜ï¼‰
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

## Quick Reference

### ç³»ç»Ÿåˆ†å±‚ï¼ˆ5 å±‚ï¼‰

```
ç”¨æˆ·å±‚ â†’ ç½‘å…³å±‚ â†’ å¾®æœåŠ¡å±‚ â†’ æ„å»ºæœºå±‚ â†’ èµ„æºå±‚
```

### æ ¸å¿ƒæ¨¡å—é€ŸæŸ¥

| æ¨¡å— | èŒè´£ | æ·±å…¥é˜…è¯» |
|------|------|----------|
| **Process** | æµæ°´çº¿ç¼–æ’ä¸æ‰§è¡Œï¼ˆæ ¸å¿ƒï¼‰ | `29-process-module-architecture` |
| **Auth** | æƒé™è®¤è¯ RBAC | `30-auth-module-architecture` |
| **Dispatch** | æ„å»ºæœºåˆ†é…è°ƒåº¦ | `35-dispatch-module-architecture` |
| **Store** | ç ”å‘å•†åº—/æ’ä»¶ç®¡ç† | `33-store-module-architecture` |
| **Worker** | ä»»åŠ¡æ‰§è¡Œå™¨ | `42-worker-module-architecture` |
| **Agent** | æ„å»ºæœºä»£ç† (Go) | `43-agent-module-architecture` |

### æµæ°´çº¿æ‰§è¡Œæ ¸å¿ƒæµç¨‹

```
è§¦å‘ â†’ Processå¼•æ“ â†’ Dispatchåˆ†é… â†’ Agenté¢†å– â†’ Workeræ‰§è¡Œ â†’ çŠ¶æ€å›ä¼ 
```

### å…³é”®ä»£ç å…¥å£

| åŠŸèƒ½ | å…¥å£ç±» |
|------|--------|
| æ‰‹åŠ¨æ„å»º | `PipelineBuildFacadeService.buildManualStartup()` |
| å¼•æ“è°ƒåº¦ | `StageControl` / `ContainerControl` / `TaskControl` |
| Worker ä¸»å¾ªç¯ | `Runner.loopPickup()` |
| ä»»åŠ¡å®Œæˆå¤„ç† | `PipelineBuildTaskService.finishTask()` |

---

## When to Use âœ…

- é¦–æ¬¡æ¥è§¦ BK-CI é¡¹ç›®ï¼Œéœ€è¦å»ºç«‹å…¨å±€è§†å›¾
- è¿›è¡Œ**è·¨æ¨¡å—å¼€å‘**ï¼Œéœ€è¦ç†è§£æ¨¡å—é—´åä½œ
- è°ƒè¯•å¤æ‚é—®é¢˜ï¼Œéœ€è¦è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾è·¯
- è§„åˆ’æ¶æ„è®¾è®¡æˆ–é‡æ„æ–¹æ¡ˆ
- ä¸ç¡®å®šæŸä¸ªåŠŸèƒ½åº”è¯¥åœ¨å“ªä¸ªæ¨¡å—å®ç°

## When NOT to Use âŒ

- åªä¿®æ”¹å•ä¸ªæ¨¡å—å†…éƒ¨é€»è¾‘ï¼ˆç›´æ¥é˜…è¯»å¯¹åº”æ¨¡å— Skillï¼‰
- ç®€å•çš„ Bug ä¿®å¤ï¼ˆä¸æ¶‰åŠè·¨æ¨¡å—è°ƒç”¨ï¼‰
- å‰ç«¯ UI è°ƒæ•´ï¼ˆé˜…è¯» `04-frontend-vue-development`ï¼‰
- æ•°æ®åº“è¡¨å˜æ›´ï¼ˆé˜…è¯» `06-database-script-management`ï¼‰

---

## ä¸€ã€ç³»ç»Ÿåˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·å±‚ (User Layer)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Web å‰ç«¯   â”‚  â”‚  OpenAPI    â”‚  â”‚  Webhook    â”‚  â”‚  ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼                â–¼                â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç½‘å…³å±‚ (Gateway Layer)                               â”‚
â”‚                    OpenResty (Nginx + Lua)                                   â”‚
â”‚  â€¢ è·¯ç”±è½¬å‘ â€¢ èº«ä»½è®¤è¯ â€¢ é™æµç†”æ–­ â€¢ æœåŠ¡å‘ç°(Consul)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¾®æœåŠ¡å±‚ (Microservice Layer)                          â”‚
â”‚  æ ¸å¿ƒ: Project | Process | Auth | Store | Repository                         â”‚
â”‚  è°ƒåº¦: Dispatch | Environment | Ticket                                       â”‚
â”‚  æ”¯æ’‘: Artifactory | Log | Notify | Quality | Metrics                        â”‚
â”‚  å¼€æ”¾: OpenAPI | WebSocket                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ„å»ºæœºå±‚ (Build Machine Layer)                        â”‚
â”‚     Agent (Go) â”€â”€â–¶ Worker (Kotlin)                                           â”‚
â”‚     è¿›ç¨‹å®ˆæŠ¤        ä»»åŠ¡æ‰§è¡Œã€æ’ä»¶è¿è¡Œã€æ—¥å¿—ä¸ŠæŠ¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        èµ„æºå±‚ (Resource Layer)                               â”‚
â”‚     MySQL | Redis | RabbitMQ | ElasticSearch | æ–‡ä»¶å­˜å‚¨                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—èŒè´£é€ŸæŸ¥è¡¨

| æ¨¡å— | æ ¸å¿ƒèŒè´£ | å…³é”®èƒ½åŠ› |
|------|----------|----------|
| **Project** | é¡¹ç›®ç®¡ç† | é¡¹ç›®åˆ›å»ºã€æˆå‘˜ç®¡ç†ã€æœåŠ¡å¼€é€šã€è·¯ç”±åˆ†ç‰‡ |
| **Process** | æµæ°´çº¿ç¼–æ’ä¸æ‰§è¡Œ | æ¨¡å‹å®šä¹‰ã€æ„å»ºè°ƒåº¦ã€äº‹ä»¶é©±åŠ¨ã€çŠ¶æ€ç®¡ç† |
| **Auth** | æƒé™è®¤è¯ | RBACã€èµ„æºæˆæƒã€ç”¨æˆ·ç»„ã€OAuth2 |
| **Store** | ç ”å‘å•†åº— | æ’ä»¶ç®¡ç†ã€æ¨¡æ¿å¸‚åœºã€ç‰ˆæœ¬å‘å¸ƒã€ç»Ÿè®¡åˆ†æ |
| **Repository** | ä»£ç åº“ç®¡ç† | Git/SVN/P4 å¯¹æ¥ã€Webhookã€PAC |
| **Dispatch** | æ„å»ºè°ƒåº¦ | æ„å»ºæœºåˆ†é…ã€Docker è°ƒåº¦ã€é…é¢ç®¡ç† |
| **Environment** | æ„å»ºæœºç¯å¢ƒ | èŠ‚ç‚¹ç®¡ç†ã€Agent å®‰è£…ã€ç¯å¢ƒå˜é‡ |
| **Ticket** | å‡­è¯ç®¡ç† | å¯†ç /SSH/Token å­˜å‚¨ã€åŠ å¯†è§£å¯† |
| **Artifactory** | åˆ¶å“åº“ | æ–‡ä»¶å­˜å‚¨ã€ç‰ˆæœ¬ç®¡ç†ã€è·¨é¡¹ç›®å…±äº« |
| **Log** | æ—¥å¿—æœåŠ¡ | æ„å»ºæ—¥å¿—æ”¶é›†ã€å­˜å‚¨ã€æ£€ç´¢ |
| **Notify** | é€šçŸ¥æœåŠ¡ | é‚®ä»¶/ä¼å¾®/RTX é€šçŸ¥ |
| **Quality** | è´¨é‡çº¢çº¿ | æŒ‡æ ‡å®šä¹‰ã€å‡†å…¥å‡†å‡ºã€æ‹¦æˆªè§„åˆ™ |
| **Agent** | æ„å»ºæœºä»£ç† | è¿›ç¨‹ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€è‡ªåŠ¨å‡çº§ |
| **Worker** | ä»»åŠ¡æ‰§è¡Œå™¨ | æ’ä»¶æ‰§è¡Œã€è„šæœ¬è¿è¡Œã€æ—¥å¿—ä¸ŠæŠ¥ |

---

## äºŒã€æµæ°´çº¿æ‰§è¡Œå…¨æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰

> **è¿™æ˜¯ BK-CI æœ€æ ¸å¿ƒçš„æµç¨‹ï¼Œæ¶‰åŠå‡ ä¹æ‰€æœ‰æ¨¡å—çš„åä½œã€‚**

### 2.1 æ‰§è¡Œæµç¨‹æ€»è§ˆå›¾

```
ç”¨æˆ·è§¦å‘
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PipelineBuild   â”‚â”€â”€â”€â”€â–¶â”‚ PipelineBuild   â”‚â”€â”€â”€â”€â–¶â”‚ PipelineRuntime â”‚
â”‚ FacadeService   â”‚     â”‚ Service         â”‚     â”‚ Service         â”‚
â”‚ (æƒé™æ ¡éªŒ)      â”‚     â”‚ (æ‹¦æˆªå™¨é“¾)      â”‚     â”‚ (åˆ›å»ºè®°å½•)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ PipelineBuildStart  â”‚
                                              â”‚ Event â†’ RabbitMQ    â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BuildStart      â”‚â”€â”€â”€â”€â–¶â”‚ StageControl    â”‚â”€â”€â”€â”€â–¶â”‚ Container       â”‚
â”‚ Control         â”‚     â”‚ (è´£ä»»é“¾)        â”‚     â”‚ Control         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â–¼                           â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Dispatch        â”‚         â”‚ TaskControl     â”‚
                   â”‚ (æ„å»ºæœºåˆ†é…)    â”‚         â”‚ (å¼•æ“ä¾§Task)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Agent (Go)      â”‚
                   â”‚ (é¢†å–ä»»åŠ¡)      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Worker (Kotlin) â”‚
                   â”‚ (æ‰§è¡ŒTask)      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ completeTask API
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ çŠ¶æ€é€å±‚å›ä¼     â”‚
                   â”‚ Taskâ†’Jobâ†’Stage  â”‚
                   â”‚ â†’Pipeline       â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ BuildEndControl â”‚
                   â”‚ (å®Œæˆå¤„ç†)      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Notify    â”‚     â”‚   Metrics   â”‚     â”‚  WebSocket  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å››ä¸ªé˜¶æ®µè¯¦è§£

#### é˜¶æ®µä¸€ï¼šè§¦å‘æ„å»º

| è§¦å‘ç±»å‹ | å…¥å£ | è¯´æ˜ |
|----------|------|------|
| æ‰‹åŠ¨è§¦å‘ | Web/API | ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œ"æŒ‰é’® |
| å®šæ—¶è§¦å‘ | Cron | `TimerTriggerElement` å®šæ—¶è°ƒåº¦ |
| ä»£ç å˜æ›´ | Webhook | Git Push/MR/Tag äº‹ä»¶ |
| è¿œç¨‹è§¦å‘ | OpenAPI | ç¬¬ä¸‰æ–¹ç³»ç»Ÿè°ƒç”¨ |

**æ ¸å¿ƒå…¥å£**ï¼š`PipelineBuildFacadeService.buildManualStartup()`

#### é˜¶æ®µäºŒï¼šå¼•æ“è°ƒåº¦

å¼•æ“é€šè¿‡**è´£ä»»é“¾æ¨¡å¼**å’Œ**äº‹ä»¶é©±åŠ¨**ï¼ŒæŒ‰ Stage â†’ Job â†’ Task å±‚çº§è°ƒåº¦ã€‚

**Stage è´£ä»»é“¾**ï¼ˆStageControlï¼‰:
1. `CheckInterruptStageCmd` â†’ æ£€æŸ¥å¿«é€Ÿå¤±è´¥
2. `CheckConditionalSkipStageCmd` â†’ æ¡ä»¶è·³è¿‡
3. `CheckPauseReviewStageCmd` â†’ æš‚åœ/å®¡æ ¸
4. `StartContainerStageCmd` â†’ **ä¸‹å‘ Container äº‹ä»¶**
5. `UpdateStateForStageCmdFinally` â†’ æ›´æ–°çŠ¶æ€

**Container è´£ä»»é“¾**ï¼ˆContainerControlï¼‰:
1. `CheckDependOnContainerCmd` â†’ Job ä¾èµ–æ£€æŸ¥
2. `CheckMutexContainerCmd` â†’ äº’æ–¥ç»„æ£€æŸ¥
3. `StartActionTaskContainerCmd` â†’ **å¯åŠ¨ Task æ‰§è¡Œ**

#### é˜¶æ®µä¸‰ï¼šä»»åŠ¡æ‰§è¡Œ

**Agent (Go)** - æ„å»ºæœºä»£ç†ï¼š
```go
for {
    result := api.AskBuild()  // å‘ Dispatch è¯·æ±‚ä»»åŠ¡
    if result.HasBuild {
        go runBuild(result.BuildInfo)  // å¼‚æ­¥æ‰§è¡Œ
    }
    time.Sleep(interval)
}
```

**Worker (Kotlin)** - ä»»åŠ¡æ‰§è¡Œå™¨ï¼š
```kotlin
loop@ while (true) {
    val buildTask = EngineService.claimTask()  // é¢†å–ä»»åŠ¡
    when (buildTask.status) {
        DO -> {
            val task = TaskFactory.create(buildTask.type)
            task.run(buildTask, buildVariables, workspace)
            EngineService.completeTask(result)  // ä¸ŠæŠ¥ç»“æœ
        }
        WAIT -> Thread.sleep(sleepMills)
        END -> break@loop
    }
}
```

#### é˜¶æ®µå››ï¼šçŠ¶æ€å›ä¼ 

```
Task å®Œæˆ â†’ PipelineBuildTaskService.finishTask()
         â†’ å‘é€ PipelineBuildContainerEvent
         â†’ Job å®Œæˆæ£€æŸ¥ â†’ Stage å®Œæˆæ£€æŸ¥ â†’ Pipeline å®Œæˆ
         â†’ Notify/Metrics/WebSocket
```

---

## ä¸‰ã€Job æ‰§è¡Œæœºåˆ¶ï¼ˆé‡è¦ï¼‰

### 3.1 ç³»ç»Ÿ Task

**é‡è¦æ¦‚å¿µ**ï¼šå¯åŠ¨æ„å»ºæœºæœ¬èº«å°±æ˜¯ä¸€ä¸ª Taskï¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           T_PIPELINE_BUILD_TASK è¡¨æ•°æ®ç¤ºä¾‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TASK_ID      â”‚ TASK_NAME          â”‚ TASK_ATOM        â”‚ TASK_SEQ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ startVM-1    â”‚ Prepare_Job#1      â”‚ dispatchVMStart  â”‚ 1  ç³»ç»Ÿ  â”‚
â”‚ e-xxx-1      â”‚ Bash               â”‚ (ç©º)             â”‚ 2  ç”¨æˆ·  â”‚
â”‚ e-xxx-2      â”‚ ä»£ç æ‹‰å–           â”‚ (ç©º)             â”‚ 3  ç”¨æˆ·  â”‚
â”‚ end-1000     â”‚ Wait_Finish_Job#1  â”‚ (ç©º)             â”‚ 1000 ç³»ç»Ÿâ”‚
â”‚ stopVM-1001  â”‚ Clean_Job#1        â”‚ dispatchVMStop   â”‚ 1001 ç³»ç»Ÿâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Worker ä¸æœåŠ¡ç«¯é€šä¿¡

| æ¥å£ | è¯´æ˜ |
|------|------|
| `jobStarted` | Worker å¯åŠ¨åè°ƒç”¨ï¼Œè¿”å› BuildVariables |
| `claimTask` | é¢†å–å¾…æ‰§è¡Œ Task |
| `completeTask` | ä¸ŠæŠ¥ Task ç»“æœï¼Œè§¦å‘ä¸‹ä¸€ä¸ª Task è°ƒåº¦ |
| `heartbeat` | å¿ƒè·³ä¿æ´» |
| `jobEnd` | Job å®Œæˆï¼Œè§¦å‘èµ„æºé‡Šæ”¾ |

### 3.3 éé˜»å¡äº‹ä»¶é©±åŠ¨

```
BK-CI äº‹ä»¶é©±åŠ¨æ–¹å¼ï¼ˆâœ… é‡‡ç”¨ï¼‰ï¼š

Process å¼•æ“
    â”‚
    â”œâ”€â”€ å‘é€è°ƒåº¦è¯·æ±‚ï¼ˆPipelineAgentStartupEventï¼‰
    â”œâ”€â”€ ç«‹å³è¿”å›ï¼Œå¤„ç†å…¶ä»–äº‹ä»¶ï¼ˆå…¶ä»–æµæ°´çº¿ã€å…¶ä»– Jobï¼‰
    â”‚
... æ—¶é—´æµé€ï¼Œæ„å»ºæœºå¯åŠ¨ä¸­ ...
    â”‚
Worker å¯åŠ¨å
    â”œâ”€â”€ è°ƒç”¨ jobStarted API
    â”œâ”€â”€ æœåŠ¡ç«¯å‘é€ PipelineBuildContainerEvent
    â”‚
å¼•æ“æ”¶åˆ°äº‹ä»¶
    â””â”€â”€ ç»§ç»­æ‰§è¡Œè¯¥ Job çš„åç»­ Task
```

**ä¼˜åŠ¿**ï¼šå•ä¸ªå¼•æ“å®ä¾‹å¯å¹¶å‘å¤„ç†å¤§é‡æ„å»ºï¼Œä¸é˜»å¡ã€‚

---

## å››ã€æœåŠ¡ä¾èµ–å…³ç³»

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Project  â”‚ â—€â”€â”€â”€â”€ æ‰€æœ‰æœåŠ¡çš„åŸºç¡€ä¾èµ–
                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Auth   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Process  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Store   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â–¼            â–¼            â–¼
         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     â”‚Repositoryâ”‚ â”‚ Dispatch â”‚ â”‚  Ticket  â”‚
         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚Environmentâ”‚
         â”‚                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                     â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚Agent/Workerâ”‚
         â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â–¼
         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     â”‚  Log | Artifactory | Notify     â”‚
         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Metrics    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æ ¸å¿ƒäº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | å¤„ç†å™¨ |
|----------|----------|--------|
| `PipelineBuildStartEvent` | æ„å»ºå¯åŠ¨ | StageControl |
| `PipelineBuildStageEvent` | Stage çŠ¶æ€å˜æ›´ | StageControl |
| `PipelineBuildContainerEvent` | Job çŠ¶æ€å˜æ›´ | ContainerControl |
| `PipelineBuildTaskFinishEvent` | ä»»åŠ¡å®Œæˆ | TaskControl |
| `PipelineBuildFinishEvent` | æ„å»ºå®Œæˆ | BuildFinishListener |
| `PipelineBuildCancelEvent` | æ„å»ºå–æ¶ˆ | CancelControl |
| `PipelineAgentStartupEvent` | æ„å»ºæœºå¯åŠ¨ | DispatchListener |

---

## å…­ã€æµæ°´çº¿æ¨¡å‹ç»“æ„

```
Model (æµæ°´çº¿æ¨¡å‹)
â”œâ”€â”€ name: String
â”œâ”€â”€ stages: List<Stage>
â”‚   â””â”€â”€ Stage
â”‚       â”œâ”€â”€ id: String (s-xxx)
â”‚       â”œâ”€â”€ checkIn/checkOut: StagePauseCheck
â”‚       â””â”€â”€ containers: List<Container>
â”‚           â””â”€â”€ Container (Job)
â”‚               â”œâ”€â”€ id: String (c-xxx)
â”‚               â”œâ”€â”€ @type: vmBuild | normal | trigger
â”‚               â”œâ”€â”€ dispatchType: DispatchType
â”‚               â””â”€â”€ elements: List<Element>
â”‚                   â””â”€â”€ Element (Task)
â”‚                       â”œâ”€â”€ id: String (t-xxx)
â”‚                       â”œâ”€â”€ @type: marketBuild | linuxScript | ...
â”‚                       â””â”€â”€ data: Map
â”œâ”€â”€ triggers: List<Trigger>
â”œâ”€â”€ params: List<BuildFormProperty>
â””â”€â”€ setting: PipelineSetting
```

---

## ä¸ƒã€æ•°æ®åº“æ ¸å¿ƒè¡¨

```
T_PROJECT
    â”‚
    â”œâ”€â”€ T_PIPELINE_INFO (æµæ°´çº¿ä¿¡æ¯)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ T_PIPELINE_RESOURCE (ç¼–æ’æ¨¡å‹)
    â”‚       â”œâ”€â”€ T_PIPELINE_SETTING (é…ç½®)
    â”‚       â””â”€â”€ T_PIPELINE_BUILD_HISTORY (æ„å»ºå†å²)
    â”‚               â”‚
    â”‚               â”œâ”€â”€ T_PIPELINE_BUILD_STAGE
    â”‚               â”œâ”€â”€ T_PIPELINE_BUILD_CONTAINER
    â”‚               â”œâ”€â”€ T_PIPELINE_BUILD_TASK
    â”‚               â””â”€â”€ T_PIPELINE_BUILD_VAR
    â”‚
    â”œâ”€â”€ T_REPOSITORY (ä»£ç åº“)
    â””â”€â”€ T_AUTH_RESOURCE (æƒé™èµ„æº)
```

---

## å…«ã€æŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯ |
|------|------|
| **åç«¯** | Kotlin/Java, Spring Boot 3, Gradle |
| **æ•°æ®åº“** | MySQL + JOOQ |
| **ç¼“å­˜/é”** | Redis |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ |
| **æ—¥å¿—æ£€ç´¢** | ElasticSearch |
| **æœåŠ¡å‘ç°** | Consul |
| **å‰ç«¯** | Vue 2.7, Vuex, bk-magic-vue |
| **Agent** | Go 1.19+ |
| **Worker** | Kotlin (JVM) |

---

## ä¹ã€Skill å¯¼èˆªç´¢å¼•

### æŒ‰æ¨¡å—æŸ¥æ‰¾

| æ¨¡å— | Skill |
|------|-------|
| å…¨å±€æ¶æ„ | 00 (æœ¬æ–‡æ¡£) |
| åç«¯å¼€å‘ | 01 |
| API è®¾è®¡ | 02 |
| å•å…ƒæµ‹è¯• | 03 |
| å‰ç«¯å¼€å‘ | 04 |
| Agent å¼€å‘ | 05, 43 |
| æ•°æ®åº“ | 06, 44 |
| Process æ¨¡å— | 28, 29 ç³»åˆ— |
| Auth æ¨¡å— | 30 |
| Store æ¨¡å— | 33 |
| Dispatch æ¨¡å— | 35 |
| Worker æ¨¡å— | 42 |

### æŒ‰åœºæ™¯æŸ¥æ‰¾

| åœºæ™¯ | æ¶‰åŠ Skill |
|------|------------|
| æ–°å¢æµæ°´çº¿åŠŸèƒ½ | 28, 29 ç³»åˆ—, 08 |
| å¼€å‘æ–°æ’ä»¶ | 33, 42 |
| ä¿®æ”¹æƒé™é€»è¾‘ | 30 |
| ä¼˜åŒ–æ„å»ºè°ƒåº¦ | 35, 36, 43 |
| æ•°æ®åº“è¡¨å˜æ›´ | 06, 44 |

---

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ¯ å†³ç­–æ¸…å•ï¼ˆæ”¾åœ¨æœ€å - å¼ºåŒ–è®°å¿†ï¼‰
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

## Checklist

å¼€å§‹è·¨æ¨¡å—å¼€å‘å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] **å·²ç†è§£æµæ°´çº¿æ‰§è¡Œæµç¨‹**ï¼šè§¦å‘ â†’ è°ƒåº¦ â†’ æ‰§è¡Œ â†’ å›ä¼ 
- [ ] **å·²ç¡®å®šæ¶‰åŠçš„æ¨¡å—**ï¼šProcess? Dispatch? Store?
- [ ] **å·²é˜…è¯»ç›¸å…³æ¨¡å— Skill**ï¼šå¦‚ `29-process-module-architecture`
- [ ] **å·²äº†è§£äº‹ä»¶é©±åŠ¨æœºåˆ¶**ï¼šé€šè¿‡ RabbitMQ å¼‚æ­¥é€šä¿¡
- [ ] **å·²ç¡®è®¤æ•°æ®æµå‘**ï¼šå“ªäº›è¡¨ä¼šè¢«è¯»å†™ï¼Ÿ

### æ ¸å¿ƒç†è§£è¦ç‚¹

1. **Process æ˜¯æ ¸å¿ƒ** - æµæ°´çº¿ç¼–æ’ã€æ„å»ºè°ƒåº¦ã€çŠ¶æ€ç®¡ç†éƒ½åœ¨è¿™é‡Œ
2. **äº‹ä»¶é©±åŠ¨** - é€šè¿‡ RabbitMQ å®ç°æ¨¡å—é—´è§£è€¦å’Œå¼‚æ­¥å¤„ç†
3. **åŒå±‚æ„å»º** - Agent(Go) è´Ÿè´£è¿›ç¨‹ç®¡ç†ï¼ŒWorker(Kotlin) è´Ÿè´£ä»»åŠ¡æ‰§è¡Œ
4. **Worker Pull æ¨¡å¼** - Worker ä¸»åŠ¨ `claimTask` é¢†å–ä»»åŠ¡
5. **éé˜»å¡ç­‰å¾…** - å¼•æ“å‘å‡ºè°ƒåº¦è¯·æ±‚åä¸é˜»å¡ï¼Œé€šè¿‡äº‹ä»¶å›è°ƒç»§ç»­
