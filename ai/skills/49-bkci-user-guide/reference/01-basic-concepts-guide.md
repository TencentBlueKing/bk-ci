# BK-CI 基础概念与架构

## 概述

BK-CI（蓝盾）是腾讯开源的一站式 DevOps 平台，提供从代码提交到应用部署的完整 CI/CD 解决方案。本章将介绍 BK-CI 的核心概念、系统架构和基本术语。

## 核心概念

### 1. 项目（Project）

**定义**: 项目是 BK-CI 中的顶级组织单元，用于隔离不同团队或产品的资源。

**特点**:
- 每个项目拥有独立的权限体系
- 项目内可以创建多条流水线
- 支持项目级别的配置和管理

**使用场景**:
```
企业组织结构 → BK-CI 项目映射
├── 移动端团队 → 移动端项目
├── Web前端团队 → 前端项目  
├── 后端服务团队 → 后端项目
└── 测试团队 → 测试项目
```

### 2. 流水线（Pipeline）

**定义**: 流水线是 BK-CI 的核心概念，定义了从代码到制品的完整自动化流程。

**组成结构**:
```
Pipeline（流水线）
├── Stage（阶段）
│   ├── Job（任务）
│   │   ├── Step（步骤）
│   │   └── Plugin（插件）
│   └── 并行/串行执行
└── 触发器（Trigger）
```

**流水线类型**:
- **经典流水线**: 可视化编排，适合复杂场景
- **YAML 流水线**: 代码化配置，支持版本控制

### 3. 阶段（Stage）

**定义**: 阶段是流水线的逻辑分组，通常代表构建过程的不同环节。

**常见阶段**:
```
典型流水线阶段划分:
├── 代码检出（Checkout）
├── 代码检查（Code Review）
├── 单元测试（Unit Test）
├── 构建打包（Build）
├── 集成测试（Integration Test）
├── 制品发布（Artifact Release）
└── 部署发布（Deploy）
```

**阶段特性**:
- 阶段间串行执行
- 阶段内任务可并行执行
- 支持阶段级别的条件控制

### 4. 任务（Job）

**定义**: 任务是阶段内的执行单元，在特定的构建环境中运行。

**任务类型**:
- **无编译环境**: 轻量级任务，如通知、审批
- **Linux 构建机**: 在 Linux 环境中执行
- **Windows 构建机**: 在 Windows 环境中执行
- **macOS 构建机**: 在 macOS 环境中执行

### 5. 插件（Plugin）

**定义**: 插件是 BK-CI 的功能扩展单元，提供特定的能力。

**插件分类**:

| 类别 | 说明 | 示例插件 |
|------|------|----------|
| 代码管理 | 代码检出、版本控制 | Git、SVN、Checkout |
| 构建工具 | 编译、打包 | Maven、Gradle、NPM |
| 测试工具 | 单元测试、集成测试 | JUnit、Jest、Pytest |
| 代码检查 | 静态分析、安全扫描 | SonarQube、ESLint |
| 制品管理 | 制品上传、下载 | 制品库、Docker |
| 部署发布 | 应用部署、环境管理 | Kubernetes、SSH |
| 通知审批 | 消息通知、人工审核 | 邮件、企微、审批 |

### 6. 构建机（Build Agent）

**定义**: 构建机是执行构建任务的计算资源。

**构建机类型**:
- **公共构建机**: 平台提供的共享资源
- **私有构建机**: 用户自建的专用资源
- **第三方构建机**: 对接外部构建资源

**构建机管理**:
```
构建机生命周期:
启动 → 注册 → 空闲 → 分配任务 → 执行 → 释放 → 关闭
```

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    BK-CI 系统架构                        │
├─────────────────────────────────────────────────────────┤
│  前端层 (Frontend)                                       │
│  ├── Web UI (Vue.js)                                   │
│  └── OpenAPI (RESTful)                                 │
├─────────────────────────────────────────────────────────┤
│  网关层 (Gateway)                                        │
│  ├── 路由转发                                           │
│  ├── 负载均衡                                           │
│  └── 权限认证                                           │
├─────────────────────────────────────────────────────────┤
│  微服务层 (Microservices)                               │
│  ├── Process (流水线服务)                               │
│  ├── Repository (代码库服务)                            │
│  ├── Artifactory (制品库服务)                           │
│  ├── Environment (环境管理服务)                         │
│  ├── Store (研发商店服务)                               │
│  ├── Project (项目管理服务)                             │
│  ├── Auth (权限认证服务)                                │
│  └── Notify (通知服务)                                  │
├─────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                     │
│  ├── MySQL (关系型数据库)                               │
│  ├── Redis (缓存数据库)                                 │
│  └── 文件存储 (NFS/对象存储)                            │
├─────────────────────────────────────────────────────────┤
│  构建层 (Build Layer)                                    │
│  ├── Dispatch (调度服务)                                │
│  ├── Agent (构建机代理)                                 │
│  └── Worker (任务执行器)                                │
└─────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. Process 模块
- **职责**: 流水线管理和构建编排
- **功能**: 流水线 CRUD、构建调度、状态管理
- **交互**: 与所有其他模块交互

#### 2. Repository 模块  
- **职责**: 代码库管理和触发器
- **功能**: 代码库接入、Webhook 处理、触发器管理
- **交互**: 与 Process 模块协作处理代码变更

#### 3. Artifactory 模块
- **职责**: 制品存储和版本管理
- **功能**: 制品上传下载、版本控制、清理策略
- **交互**: 为构建提供制品存储服务

#### 4. Environment 模块
- **职责**: 构建环境和节点管理
- **功能**: 构建机管理、环境变量、节点监控
- **交互**: 为 Process 提供执行环境

## 基本术语

### 构建相关

| 术语 | 英文 | 说明 |
|------|------|------|
| 构建 | Build | 一次流水线的完整执行过程 |
| 构建号 | Build Number | 构建的唯一标识，递增数字 |
| 构建状态 | Build Status | 构建的执行状态（成功/失败/进行中） |
| 构建历史 | Build History | 流水线的历史执行记录 |
| 构建产物 | Build Artifact | 构建过程中产生的文件或制品 |

### 流程相关

| 术语 | 英文 | 说明 |
|------|------|------|
| 触发器 | Trigger | 启动流水线执行的条件或事件 |
| 变量 | Variable | 流水线中使用的参数和配置 |
| 参数 | Parameter | 流水线启动时的输入参数 |
| 条件 | Condition | 控制流水线执行路径的逻辑条件 |
| 依赖 | Dependency | 任务或阶段间的执行依赖关系 |

### 环境相关

| 术语 | 英文 | 说明 |
|------|------|------|
| 工作空间 | Workspace | 构建任务的工作目录 |
| 环境变量 | Environment Variable | 构建环境中的系统变量 |
| 构建脚本 | Build Script | 在构建机上执行的脚本命令 |
| 构建镜像 | Build Image | 容器化构建环境的镜像 |

## 工作流程

### 典型 CI/CD 流程

```
开发提交代码
    ↓
触发器检测到变更
    ↓
启动流水线执行
    ↓
代码检出到构建机
    ↓
执行构建脚本
    ↓
运行测试用例
    ↓
代码质量检查
    ↓
构建应用制品
    ↓
制品上传到制品库
    ↓
部署到测试环境
    ↓
自动化测试验证
    ↓
部署到生产环境
```

### 权限控制流程

```
用户访问 BK-CI
    ↓
身份认证（登录）
    ↓
权限校验（项目权限）
    ↓
操作授权（功能权限）
    ↓
资源访问（数据权限）
```

## 最佳实践

### 1. 项目规划
- 按业务线或团队划分项目
- 合理设置项目权限边界
- 建立项目命名规范

### 2. 流水线设计
- 遵循单一职责原则
- 合理划分阶段和任务
- 充分利用并行执行能力

### 3. 插件使用
- 优先使用官方插件
- 合理配置插件参数
- 关注插件版本兼容性

### 4. 构建优化
- 合理选择构建机类型
- 优化构建脚本性能
- 使用缓存加速构建

## 下一步

了解了 BK-CI 的基础概念后，建议继续学习：

1. [项目与权限管理](./02-project-permission-guide.md) - 创建和管理项目
2. [流水线创建与配置](./04-pipeline-creation-guide.md) - 创建第一条流水线
3. [代码库接入与管理](./03-repository-management-guide.md) - 接入代码库

---

*本章介绍了 BK-CI 的核心概念和架构，为后续的具体操作奠定基础。*