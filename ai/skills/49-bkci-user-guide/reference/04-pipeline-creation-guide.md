# 流水线创建与配置

## 概述

流水线是 BK-CI 的核心功能，定义了从代码到制品的完整自动化流程。本章将详细介绍如何创建和配置流水线，包括阶段设计、任务配置、插件使用等关键内容。

## 流水线基础

### 流水线类型

#### 1. 经典流水线
**特点**: 可视化编排，拖拽式配置
```yaml
适用场景:
  - 复杂的构建流程
  - 需要条件分支的场景
  - 多环境部署
  - 需要人工审批的流程
  
优势:
  - 可视化编辑
  - 丰富的插件生态
  - 灵活的流程控制
  - 实时状态展示
```

#### 2. YAML 流水线
**特点**: 代码化配置，版本控制
```yaml
适用场景:
  - 简单的 CI/CD 流程
  - 需要版本控制的配置
  - 批量复制和修改
  - 模板化管理
  
优势:
  - 配置即代码
  - 版本控制
  - 批量操作
  - 模板复用
```

### 流水线结构

#### 基本结构层次
```
Pipeline (流水线)
├── Trigger (触发器)
│   ├── 代码库触发
│   ├── 定时触发
│   └── 手动触发
├── Stage (阶段)
│   ├── Job (任务)
│   │   ├── Step (步骤)
│   │   └── Plugin (插件)
│   └── 执行条件
└── Variable (变量)
    ├── 流水线变量
    ├── 环境变量
    └── 参数变量
```

## 创建流水线

### 快速创建

#### 1. 使用模板创建

**路径**: `项目 → 流水线 → 新建流水线 → 选择模板`

**常用模板**:
```yaml
前端应用模板:
  - Node.js 构建
  - 静态资源打包
  - 部署到 CDN
  
后端服务模板:
  - Java/Maven 构建
  - 单元测试
  - Docker 镜像构建
  - Kubernetes 部署
  
移动应用模板:
  - Android/iOS 构建
  - 代码签名
  - 应用分发
```

#### 2. 空白流水线创建

**创建步骤**:
1. 点击"新建流水线"
2. 选择"空白流水线"
3. 填写基本信息
4. 配置触发器
5. 添加阶段和任务

**基本信息配置**:
```yaml
流水线信息:
  流水线名称: mobile-app-ci
  流水线描述: 移动端应用持续集成流水线
  流水线分组: 移动端
  
高级设置:
  并发设置: 允许并发执行
  超时设置: 60 分钟
  失败策略: 快速失败
```

### 阶段设计

#### 1. 典型阶段划分

**标准 CI/CD 阶段**:
```yaml
阶段 1: 代码检出
  目的: 获取源代码
  任务:
    - Git Checkout
    - 子模块更新
    - 代码缓存
    
阶段 2: 代码检查
  目的: 代码质量保证
  任务:
    - 静态代码分析
    - 代码格式检查
    - 安全扫描
    
阶段 3: 构建测试
  目的: 编译和测试
  任务:
    - 依赖安装
    - 代码编译
    - 单元测试
    - 测试报告
    
阶段 4: 制品构建
  目的: 生成部署制品
  任务:
    - 应用打包
    - Docker 镜像构建
    - 制品上传
    
阶段 5: 部署发布
  目的: 应用部署
  任务:
    - 环境准备
    - 应用部署
    - 健康检查
    - 通知相关人员
```

#### 2. 阶段配置选项

**执行条件**:
```yaml
条件类型:
  - 总是执行: 无论前面阶段成功或失败
  - 成功时执行: 前面所有阶段成功
  - 失败时执行: 前面任一阶段失败
  - 自定义条件: 基于变量或表达式
  
示例配置:
  部署阶段:
    执行条件: 成功时执行
    自定义条件: ${BUILD_BRANCH} == "master"
    
  通知阶段:
    执行条件: 总是执行
    用途: 无论成功失败都发送通知
```

**并发控制**:
```yaml
阶段并发:
  串行执行: 阶段按顺序执行
  并行执行: 同级阶段同时执行
  
任务并发:
  串行任务: 任务按顺序执行
  并行任务: 同阶段任务同时执行
  
示例:
  测试阶段:
    - 单元测试任务 (并行)
    - 集成测试任务 (并行)
    - 性能测试任务 (并行)
```

### 任务配置

#### 1. 任务类型选择

**构建环境类型**:
```yaml
无编译环境:
  适用: 轻量级任务
  示例: 通知、审批、API 调用
  资源: 无需构建机
  
Linux 构建机:
  适用: 大部分构建任务
  示例: Java、Node.js、Python 构建
  资源: Linux 虚拟机或容器
  
Windows 构建机:
  适用: .NET、Windows 应用
  示例: C#、PowerShell 脚本
  资源: Windows 虚拟机
  
macOS 构建机:
  适用: iOS、macOS 应用
  示例: Xcode 构建、iOS 打包
  资源: macOS 虚拟机
```

#### 2. 任务基础配置

**任务设置**:
```yaml
任务信息:
  任务名称: 后端服务构建
  任务描述: 编译 Java 后端服务
  
执行环境:
  构建机类型: Linux
  构建机标签: java,maven
  镜像: openjdk:11-jdk
  
高级设置:
  超时时间: 30 分钟
  重试次数: 2
  失败策略: 终止流水线
```

## 插件使用

### 常用插件分类

#### 1. 代码管理插件

**Checkout 插件**:
```yaml
插件功能: 代码检出
配置参数:
  代码库: 选择关联的代码库
  分支: ${BUILD_BRANCH}
  检出路径: ./
  子模块: 启用递归检出
  
高级配置:
  检出策略: 增量检出
  清理工作空间: 构建前清理
  LFS 支持: 启用大文件支持
```

**Git 插件**:
```yaml
插件功能: Git 操作
使用场景:
  - 创建标签
  - 推送代码
  - 合并分支
  
配置示例:
  操作类型: 创建标签
  标签名称: v${BUILD_NUMBER}
  标签信息: Release version ${BUILD_NUMBER}
```

#### 2. 构建工具插件

**Maven 插件**:
```yaml
插件功能: Java Maven 构建
配置参数:
  Maven 目标: clean compile test package
  POM 文件: pom.xml
  Maven 配置: settings.xml
  
环境配置:
  Java 版本: JDK 11
  Maven 版本: 3.6.3
  
高级选项:
  跳过测试: false
  并行构建: -T 4
  离线模式: false
```

**Gradle 插件**:
```yaml
插件功能: Java Gradle 构建
配置参数:
  Gradle 任务: clean build
  构建文件: build.gradle
  
环境配置:
  Java 版本: JDK 11
  Gradle 版本: 7.0
  
性能优化:
  并行构建: --parallel
  构建缓存: --build-cache
  守护进程: --daemon
```

**NPM 插件**:
```yaml
插件功能: Node.js 包管理
配置参数:
  NPM 命令: install
  工作目录: ./frontend
  Registry: https://registry.npmjs.org/
  
高级配置:
  缓存目录: ~/.npm
  生产依赖: --production
  忽略脚本: --ignore-scripts
```

#### 3. 测试工具插件

**JUnit 插件**:
```yaml
插件功能: Java 单元测试
配置参数:
  测试报告路径: target/surefire-reports/*.xml
  测试结果展示: 详细报告
  
失败处理:
  测试失败时: 标记构建不稳定
  无测试时: 不影响构建结果
```

**Jest 插件**:
```yaml
插件功能: JavaScript 测试
配置参数:
  配置文件: jest.config.js
  测试路径: src/**/*.test.js
  覆盖率报告: --coverage
  
报告配置:
  覆盖率阈值: 80%
  报告格式: lcov,text
```

#### 4. 代码质量插件

**SonarQube 插件**:
```yaml
插件功能: 代码质量分析
配置参数:
  SonarQube 服务器: sonar.example.com
  项目 Key: mobile-app-backend
  项目名称: Mobile App Backend
  
分析配置:
  源码路径: src/
  测试路径: src/test/
  覆盖率报告: target/site/jacoco/jacoco.xml
  
质量门禁:
  等待质量门禁: 启用
  超时时间: 5 分钟
```

**ESLint 插件**:
```yaml
插件功能: JavaScript 代码检查
配置参数:
  配置文件: .eslintrc.js
  检查路径: src/
  输出格式: junit
  
规则配置:
  忽略文件: .eslintignore
  修复错误: --fix
  最大警告数: 0
```

#### 5. 制品管理插件

**制品库插件**:
```yaml
插件功能: 制品上传下载
上传配置:
  制品路径: target/*.jar
  目标路径: releases/${BUILD_NUMBER}/
  
下载配置:
  制品路径: releases/latest/app.jar
  下载路径: ./app.jar
```

**Docker 插件**:
```yaml
插件功能: Docker 镜像构建
配置参数:
  Dockerfile: ./Dockerfile
  镜像名称: mobile-app:${BUILD_NUMBER}
  构建参数: --build-arg VERSION=${BUILD_NUMBER}
  
推送配置:
  镜像仓库: registry.example.com
  推送标签: latest,${BUILD_NUMBER}
```

#### 6. 部署发布插件

**SSH 插件**:
```yaml
插件功能: SSH 远程执行
配置参数:
  目标主机: deploy.example.com
  用户名: deployer
  SSH 私钥: [凭证管理]
  
执行脚本:
  - cd /opt/app
  - ./stop.sh
  - cp app.jar app-backup.jar
  - ./start.sh
```

**Kubernetes 插件**:
```yaml
插件功能: K8s 应用部署
配置参数:
  集群配置: kubeconfig
  命名空间: production
  部署文件: k8s/deployment.yaml
  
部署策略:
  滚动更新: RollingUpdate
  最大不可用: 1
  最大超出: 1
```

### 插件参数配置

#### 1. 变量引用

**变量类型**:
```yaml
系统变量:
  - ${BUILD_NUMBER}: 构建号
  - ${BUILD_ID}: 构建 ID
  - ${PIPELINE_NAME}: 流水线名称
  - ${PROJECT_NAME}: 项目名称
  
环境变量:
  - ${WORKSPACE}: 工作空间路径
  - ${JAVA_HOME}: Java 安装路径
  - ${PATH}: 系统路径
  
自定义变量:
  - ${APP_VERSION}: 应用版本
  - ${DEPLOY_ENV}: 部署环境
  - ${BRANCH_NAME}: 分支名称
```

#### 2. 条件执行

**插件执行条件**:
```yaml
条件表达式:
  - ${BUILD_BRANCH} == "master"
  - ${DEPLOY_ENV} in ["test", "prod"]
  - ${SKIP_TESTS} != "true"
  
组合条件:
  - ${BUILD_BRANCH} == "master" && ${DEPLOY_ENV} == "prod"
  - ${BUILD_BRANCH} startsWith "release/" || ${BUILD_BRANCH} == "master"
```

## 流水线变量

### 变量类型

#### 1. 系统内置变量

**构建相关变量**:
```yaml
基础变量:
  BUILD_NUMBER: 构建编号 (自增)
  BUILD_ID: 构建唯一标识
  BUILD_URL: 构建详情链接
  
时间变量:
  BUILD_START_TIME: 构建开始时间
  BUILD_END_TIME: 构建结束时间
  CURRENT_TIME: 当前时间戳
  
项目变量:
  PROJECT_NAME: 项目名称
  PROJECT_NAME_CN: 项目中文名
  PIPELINE_NAME: 流水线名称
  PIPELINE_ID: 流水线 ID
```

**代码相关变量**:
```yaml
Git 变量:
  GIT_COMMIT: 提交 SHA
  GIT_COMMIT_SHORT: 短 SHA (7位)
  GIT_BRANCH: 分支名称
  GIT_TAG: 标签名称
  GIT_AUTHOR: 提交作者
  GIT_MESSAGE: 提交信息
  
仓库变量:
  REPO_NAME: 仓库名称
  REPO_URL: 仓库地址
  REPO_TYPE: 仓库类型 (git/svn)
```

#### 2. 自定义变量

**流水线变量定义**:
```yaml
变量配置:
  变量名: APP_VERSION
  变量值: 1.0.${BUILD_NUMBER}
  变量描述: 应用版本号
  
变量类型:
  字符串: 普通文本值
  密码: 加密存储，日志中隐藏
  选择: 预定义选项列表
```

**参数化变量**:
```yaml
参数定义:
  参数名: DEPLOY_ENVIRONMENT
  参数类型: 选择参数
  选项值: dev,test,staging,prod
  默认值: test
  描述: 选择部署环境
  
使用方式:
  - 手动触发时选择
  - API 触发时传递
  - 其他流水线调用时指定
```

### 变量作用域

#### 1. 全局变量
```yaml
作用范围: 整个流水线
定义位置: 流水线设置 → 变量管理
使用场景: 
  - 应用版本号
  - 部署环境
  - 通用配置
```

#### 2. 阶段变量
```yaml
作用范围: 特定阶段内
定义位置: 阶段设置 → 环境变量
使用场景:
  - 阶段特定配置
  - 临时变量
  - 环境隔离
```

#### 3. 任务变量
```yaml
作用范围: 特定任务内
定义位置: 任务设置 → 环境变量
使用场景:
  - 插件特定参数
  - 任务临时变量
  - 工具配置
```

## 流程控制

### 条件执行

#### 1. 阶段条件
```yaml
条件类型:
  成功时执行: 前置阶段全部成功
  失败时执行: 前置阶段任一失败
  总是执行: 无论成功失败都执行
  自定义条件: 基于变量表达式
  
示例配置:
  部署阶段:
    执行条件: 成功时执行 && ${DEPLOY_ENV} != "skip"
    
  回滚阶段:
    执行条件: 失败时执行 && ${AUTO_ROLLBACK} == "true"
    
  通知阶段:
    执行条件: 总是执行
```

#### 2. 任务条件
```yaml
任务执行条件:
  - ${BUILD_BRANCH} == "master"
  - ${SKIP_TESTS} != "true"
  - ${DEPLOY_ENV} in ["prod", "staging"]
  
复杂条件:
  - (${BUILD_BRANCH} == "master" || ${BUILD_BRANCH} startsWith "release/") && ${QUALITY_GATE} == "passed"
```

### 并行执行

#### 1. 阶段并行
```yaml
并行阶段设计:
  阶段组 1: 代码检查
    - 静态分析任务
    - 安全扫描任务
    - 依赖检查任务
    
  阶段组 2: 构建测试
    - 单元测试任务
    - 集成测试任务
    - 性能测试任务
```

#### 2. 任务并行
```yaml
并行任务配置:
  构建阶段:
    任务 1: 前端构建 (并行)
    任务 2: 后端构建 (并行)
    任务 3: 文档构建 (并行)
    
  部署阶段:
    任务 1: 应用部署 (串行)
    任务 2: 数据库迁移 (串行)
    任务 3: 健康检查 (串行)
```

### 错误处理

#### 1. 失败策略
```yaml
快速失败:
  行为: 任一任务失败立即停止
  适用: 关键路径，节省资源
  
继续执行:
  行为: 忽略失败继续执行
  适用: 非关键任务，收集更多信息
  
条件失败:
  行为: 基于条件决定是否失败
  适用: 可选任务，灵活控制
```

#### 2. 重试机制
```yaml
任务重试配置:
  重试次数: 3
  重试间隔: 30 秒
  重试条件: 非零退出码
  
插件重试配置:
  网络插件: 自动重试 3 次
  部署插件: 手动确认重试
  测试插件: 不重试
```

## 最佳实践

### 流水线设计原则

#### 1. 单一职责
```yaml
原则: 每条流水线专注一个目标
示例:
  CI 流水线: 专注代码集成和测试
  CD 流水线: 专注部署和发布
  维护流水线: 专注清理和维护
```

#### 2. 快速反馈
```yaml
原则: 尽早发现问题，快速反馈
实践:
  - 代码检查前置
  - 单元测试优先
  - 并行执行加速
  - 增量构建优化
```

#### 3. 可重复性
```yaml
原则: 构建结果可重复
实践:
  - 版本锁定依赖
  - 环境一致性
  - 构建脚本标准化
  - 制品版本管理
```

### 性能优化

#### 1. 构建加速
```yaml
缓存策略:
  依赖缓存: Maven/NPM 依赖缓存
  构建缓存: 编译结果缓存
  镜像缓存: Docker 层缓存
  
并行优化:
  任务并行: 独立任务并行执行
  阶段并行: 无依赖阶段并行
  构建并行: 多线程编译
```

#### 2. 资源优化
```yaml
构建机选择:
  CPU 密集: 高 CPU 配置
  内存密集: 高内存配置
  IO 密集: SSD 存储
  
资源复用:
  构建机池: 共享构建资源
  镜像复用: 基础镜像标准化
  工具复用: 构建工具预安装
```

## 常见问题

### 配置问题

**Q: 流水线执行失败**
```yaml
排查步骤:
  1. 查看构建日志
  2. 检查插件配置
  3. 验证环境变量
  4. 确认权限设置
  5. 检查资源可用性
```

**Q: 变量引用失效**
```yaml
常见原因:
  - 变量名拼写错误
  - 变量作用域不正确
  - 变量值为空
  - 特殊字符转义问题
```

### 性能问题

**Q: 构建速度慢**
```yaml
优化方向:
  1. 启用并行执行
  2. 使用构建缓存
  3. 优化依赖下载
  4. 选择合适构建机
  5. 减少不必要步骤
```

## 下一步

完成流水线创建后，建议继续学习：

1. [构建环境与执行](./05-build-environment-guide.md) - 配置构建环境
2. [制品管理与发布](./06-artifact-management-guide.md) - 管理构建制品
3. [质量红线与代码检查](./07-quality-gate-guide.md) - 配置质量门禁

---

*本章介绍了流水线创建和配置的完整流程，为自动化 CI/CD 奠定基础。*