version: "v2.0"
name: "bk-ci前端部署【test-devx】"
variables:
  modules: "nav,pipeline,vs,ticket,codelib,quality,turbo,atomstore,environment,experience,metrics,stream,metrics,permission,manage"
  ips: "11.185.145.49"
  # 9.134.78.69,10.123.135.151,9.66.32.218
  #
on:
  push: ["test"]

stages:
  - name: "Build"
    label:
      - "Build"
    jobs:
      job_1:
        name: "构建环境-LINUX"
        runs-on:
          container:
            image: mirrors.tencent.com/ci/tlinux3_ci:2.5.0
        steps:
          - checkout: "http://git.woa.com/bkdevops/bk-ci.git"
            name: Checkout
            with:
              refName: test
              enableGitCleanIgnore: true
          - name: "拉取前端占位符"
            checkout: "http://git.woa.com/bkdevops/devops-config.git"
            with:
              pullType: "BRANCH"
              refName: "integration"
              localPath: "devops-config"
          - run: |

              cd src/frontend
              yarn
              yarn public -e test -l v2 -t tencent

              cd ./frontend/ || exit 1

              cp -rf ${WORKSPACE}/devops-config/gateway_frontend/* ${WORKSPACE}/
              rm -r ${WORKSPACE}/ci || echo "no ci director"
              mkdir -p ${WORKSPACE}/ci/frontend

              cp -r ./* ${WORKSPACE}/ci/frontend/
              cp ./console/frontend#console#index.html ${WORKSPACE}/support-files/templates/ || echo "no console module"
              cp ./pipeline/frontend#pipeline#index.html ${WORKSPACE}/support-files/templates/ || echo "no pipeline module"
              cp ./stream/frontend#stream#index.html ${WORKSPACE}/support-files/templates/ || echo "no stream module"
              cp ./manage/frontend#manage#index.html ${{ ci.workspace }}/support-files/templates/ || echo "no manage module"
              cp ./permission/frontend#permission#index.html ${{ ci.workspace }}/support-files/templates/ || echo "no permission module"

              cd ${WORKSPACE}/scripts/
              cp -rf ci_env_test.properties ci_env.properties

              echo "PAAS_LOGIN_URL='login.devx.tencent.com/login/?c_url=%s'" >> ci_env.properties
              echo "WOA_LOGIN_SERVICE_URL='//login.devx.tencent.com/login/?c_url=%s'" >> ci_env.properties
              echo "BKCI_FQDN='test.devx.tencet.com'" >> ci_env.properties

              sh ./render_ci -m ci ../support-files/templates/*

              cd ${WORKSPACE}/ci/frontend/
              zip -r frontend.zip ./* && cp frontend.zip ${WORKSPACE}
          - name: "Upload"
            uses: "UploadArtifactory@1.*"
            with:
              filePath: "frontend.zip"
  - name: "Deploy"
    label:
      - "Deploy"
    jobs:
      job_2:
        name: "无编译环境"
        runs-on: agentless
        steps:
          - name: "分发"
            uses: "jobFileTransferForOA@1.*"
            with:
              bizId: "100205"
              srcType: "PIPELINE"
              srcPath: "frontend.zip"
              targetIpList: ${{ variables.ips }}
              targetAccount: "root"
              targetPath: "/data/tmp-devx"
          - name: "发布"
            uses: "jobExecuteScriptForOA@1.*"
            with:
              bizId: "100205"
              scriptType: "1"
              scriptContent: |
                cd /data/tmp-devx
                rm -rf frontend
                mkdir -p frontend
                unzip -o frontend.zip -d frontend
                mkdir -p /data/bkee/ci/frontend-devx
                cp -rf /data/tmp-devx/frontend/* /data/bkee/ci/frontend-devx

              account: "root"
              targetIpList: ${{ variables.ips }}

notices:
  - type: wework-message
