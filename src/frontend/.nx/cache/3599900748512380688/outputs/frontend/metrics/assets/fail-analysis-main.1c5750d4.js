import{h as T,S as L,u as R,M as Y}from"./bk-chart.min.0b6debc5.js";import{s as O}from"./props-type.eada51fa.js";import{d as N,u as S,r as k,o as B,c as G,g as d,e,w as P,h as z,t as $,j as g,k as V,l as j,m as U,b as v,y as H,q as A,aq as J,a as K,F as Q}from"./index.b20f0f2b.js";import{_ as F}from"./plugin-vue_export-helper.21dcd24c.js";import{d as W}from"./doughnut.c62304fa.js";import{E as X}from"./empty-table-status.e7f78ca9.js";const Z={class:"main-filter mt20"},ee=N({__name:"analysis-filter",props:O,emits:["change"],setup(w,{emit:_}){const{t}=S(),c=_,{handleChange:n,handleTimeChange:l}=R(c),o=()=>{n({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[]})},h=a=>a&&a.getTime()>Date.now();return(a,s)=>{const x=k("bk-date-picker"),i=k("bk-button");return B(),G("section",Z,[d(e(L),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:e(t)("Pipelines"),multiple:!0,"api-method":e(T).getPipelineList,"select-value":a.status.pipelineIds,onChange:s[0]||(s[0]=m=>e(n)({pipelineIds:m}))},null,8,["placeholder","api-method","select-value"]),d(e(L),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:e(t)("Error type"),multiple:!0,"api-method":e(T).getErrorTypeList,"select-value":a.status.errorTypes,onChange:s[1]||(s[1]=m=>e(n)({errorTypes:m}))},null,8,["placeholder","api-method","select-value"]),d(e(L),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:e(t)("Pipeline Label"),multiple:!0,"api-method":e(T).getPipelineLabels,"select-value":a.status.pipelineLabelIds,onChange:s[2]||(s[2]=m=>e(n)({pipelineLabelIds:m}))},null,8,["placeholder","api-method","select-value"]),d(e(L),{class:"mr8 w240","id-key":"errorCode","name-key":"errorCode","atom-code":a.atomCode,placeholder:e(t)("Error code"),multiple:!0,"api-method":e(T).getErrorCodeList,"select-value":a.status.errorCodes,onChange:s[3]||(s[3]=m=>e(n)({errorCodes:m}))},null,8,["atom-code","placeholder","api-method","select-value"]),d(x,{class:"mr16 w240",type:"daterange","disable-date":h,"model-value":[a.status.startTime,a.status.endTime],onChange:e(l)},null,8,["model-value","onChange"]),d(i,{disabled:a.resetBtnDisabled,onClick:o},{default:P(()=>[z($(e(t)("Reset")),1)]),_:1},8,["disabled"])])}}});var te=F(ee,[["__scopeId","data-v-81751f0a"]]);const ae={class:"g-card-title"},ne=N({__name:"analysis-doughnut",props:O,setup(w){const{t:_}=S(),t=w,c=g(!1),n=g({labels:[],list:[]}),l=()=>{c.value=!0,T.getErrorCodeStatisticsInfo(t.status).then(o=>{o==null||o.forEach(h=>{var a;n.value.labels.push((a=h.errorCodeInfo)==null?void 0:a.errorTypeName),n.value.list.push(h.errorCount)})}).finally(()=>{c.value=!1})};return V(()=>t.status,()=>{n.value.list=[],n.value.labels=[],l()}),j(l),(o,h)=>{const a=k("bk-loading");return B(),U(a,{class:"analysis-doughnut overview-card mt20",loading:c.value},{default:P(()=>[v("h3",ae,$(e(_)("Statistics of error code")),1),d(e(W),{data:n.value},null,8,["data"])]),_:1},8,["loading"])}}});var se=F(ne,[["__scopeId","data-v-416885aa"]]);const le={class:"g-card-title"},oe=N({__name:"analysis-table",props:O,emits:["change","clear"],setup(w,{emit:_}){const{t}=S();H();const c=_,{handleChange:n}=R(c),l=w,o=g(!1),h=[{label:t("Pipeline"),field:"pipelineName",showOverflowTooltip:!0,render({cell:u,row:r}){return A("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){const b=r.projectId,f=r.pipelineId,E=r.buildId,p=r.atomPosition&&r.atomPosition.split("-");let y,C,M,I;p.length===3?(y=p[0],C=p[1],I=p[2]):p.length===4&&(y=p[0],C=p[1],M=p[2],I=p[3]),r.channelCode==="BS"?p.length===3?window.open(`https://${r.domain}/console/pipeline/${b}/${f}/detail/${E}?stageIndex=${y}&containerIndex=${C}&elementIndex=${I}`,"_blank"):window.open(`https://${r.domain}/console/pipeline/${b}/${f}/detail/${E}?stageIndex=${y}&containerIndex=${C}&containerGroupIndex=${M}&elementIndex=${I}`,"_blank"):r.channelCode==="GIT"&&(p.length===3?window.open(`https://${r.domain}/pipeline/${f}/detail/${E}/?page=1&stageIndex=${y}&containerIndex=${C}&elementIndex=${I}#${b.split("_")[1]}`,"_blank"):window.open(`https://${r.domain}/pipeline/${f}/detail/${E}/?page=1&stageIndex=${y}&containerIndex=${C}&containerGroupIndex=${M}&elementIndex=${I}#${b.split("_")[1]}`,"_blank"))}},[u," #",r.buildNum])}},{label:t("Plugin"),field:"atomName",showOverflowTooltip:!0},{label:t("Start Time"),field:"startTime",showOverflowTooltip:!0,sort:!0},{label:t("Username"),field:"startUser",showOverflowTooltip:!0},{label:t("Error Type"),field:"errorTypeName",showOverflowTooltip:!0},{label:t("Error Code"),field:"errorCode",showOverflowTooltip:!0,sort:!0},{label:t("Error Message"),field:"errorMsg",showOverflowTooltip:!0,sort:!0,render({cell:u,row:r}){return A("span",[u])}}],a=g([]),s=g({current:1,count:0,limit:10}),x=J(()=>l.status.pipelineIds.length||l.status.pipelineLabelIds.length||l.status.errorTypes.length||l.status.errorCodes.length||l.status.startTime||l.status.endTime?"search-empty":"empty"),i=()=>{c("clear",{pipelineIds:[],pipelineLabelIds:[],errorTypes:[],errorCodes:[],startTime:"",endTime:""})},m=u=>{s.value.current=u,D()},q=u=>{s.value.limit=u,D()},D=()=>{o.value=!0,T.getErrorCodeInfoDetail(l.status,s.value.current,s.value.limit).then(u=>{s.value.count=u.count,a.value=u.records}).finally(()=>{o.value=!1,n(!1)})};return V(()=>l.status,D),j(D),(u,r)=>{const b=k("bk-table"),f=k("bk-loading");return B(),U(f,{class:"overview-card mt20",loading:o.value},{default:P(()=>[v("h3",le,$(e(t)("Details")),1),d(b,{class:"analysis-table",columns:h,data:a.value,"remote-pagination":"",settings:"",pagination:s.value,onPageValueChange:m,onPageLimitChange:q},{empty:P(()=>[d(X,{type:x.value,onClear:i},null,8,["type"])]),_:1},8,["data","pagination"])]),_:1},8,["loading"])}}});var ie=F(oe,[["__scopeId","data-v-65db44cc"]]);const re={class:"header"},de=v("span",{class:"crumbs-icon"}," > ",-1),ue={class:"g-content"},ve=N({__name:"fail-analysis-main",setup(w){const{t:_}=S(),t=K(),c=H(),n=g({pipelineIds:[t.query.pipelineId].filter(i=>i),pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[],atomCodes:[t.query.atomCode].filter(i=>i)}),l=g(t.query.atomCode||""),o=g(!1),h=i=>{o.value=i},a=i=>{o.value=!0,n.value={...n.value,...i}},s=()=>{c.push({name:"PluginRunAnalysis"})},x=i=>{a(i)};return(i,m)=>{const q=k("bk-alert");return B(),G(Q,null,[d(e(Y),null,{default:P(()=>[v("div",re,[v("a",{class:"plugin-trend-title",onClick:s},$(e(_)("Plugin trend")),1),de,v("span",null,$(e(_)("Plugin fail analysis"))+": "+$(e(t).query.atomCode),1)])]),_:1}),v("main",ue,[d(q,{theme:"info",title:e(_)("You can only query the statistics in the last 6 months!")},null,8,["title"]),d(te,{"reset-btn-disabled":o.value,status:n.value,"atom-code":l.value,onChange:a},null,8,["reset-btn-disabled","status","atom-code"]),d(se,{status:n.value},null,8,["status"]),d(ie,{status:n.value,"reset-btn-disabled":o.value,onChange:h,onClear:x},null,8,["status","reset-btn-disabled"])])],64)}}});export{ve as default};
