import{h as I,S as D,u as F,M as U}from"./bk-chart.min.e4cb5b29.js";import{s as L}from"./props-type.eada51fa.js";import{d as E,u as N,r as k,o as M,c as A,g as u,e,w as S,h as H,t as $,j as g,k as R,l as G,m as V,b as h,y as j,q,a as Y,F as z}from"./index.5d40bf3f.js";import{_ as w}from"./plugin-vue_export-helper.21dcd24c.js";import{d as J}from"./doughnut.2ef5d023.js";import"./use-color.b34df27b.js";const K={class:"main-filter mt20"},O=E({__name:"analysis-filter",props:L,emits:["change"],setup(T,{emit:m}){const{t:s}=N(),{handleChange:a,handleTimeChange:o}=F(m),_=()=>{a({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[]})},i=n=>n&&n.getTime()>Date.now();return(n,t)=>{const x=k("bk-date-picker"),c=k("bk-button");return M(),A("section",K,[u(e(D),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:e(s)("Pipelines"),multiple:!0,"api-method":e(I).getPipelineList,"select-value":n.status.pipelineIds,onChange:t[0]||(t[0]=r=>e(a)({pipelineIds:r}))},null,8,["placeholder","api-method","select-value"]),u(e(D),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:e(s)("Error type"),multiple:!0,"api-method":e(I).getErrorTypeList,"select-value":n.status.errorTypes,onChange:t[1]||(t[1]=r=>e(a)({errorTypes:r}))},null,8,["placeholder","api-method","select-value"]),u(e(D),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:e(s)("Pipeline lable"),multiple:!0,"api-method":e(I).getPipelineLabels,"select-value":n.status.pipelineLabelIds,onChange:t[2]||(t[2]=r=>e(a)({pipelineLabelIds:r}))},null,8,["placeholder","api-method","select-value"]),u(e(D),{class:"mr8 w240","id-key":"errorCode","name-key":"errorCode","atom-code":n.atomCode,placeholder:e(s)("Error code"),multiple:!0,"api-method":e(I).getErrorCodeList,"select-value":n.status.errorCodes,onChange:t[3]||(t[3]=r=>e(a)({errorCodes:r}))},null,8,["atom-code","placeholder","api-method","select-value"]),u(x,{class:"mr16 w240",type:"daterange","disable-date":i,"model-value":[n.status.startTime,n.status.endTime],onChange:e(o)},null,8,["model-value","onChange"]),u(c,{disabled:n.resetBtnDisabled,onClick:_},{default:S(()=>[H($(e(s)("Reset")),1)]),_:1},8,["disabled"])])}}});var Q=w(O,[["__scopeId","data-v-50fc3bc9"]]);const W={class:"g-card-title"},X=E({__name:"analysis-doughnut",props:L,setup(T){const m=T,{t:s}=N(),a=g(!1),o=g({labels:[],list:[]}),_=()=>{a.value=!0,I.getErrorCodeStatisticsInfo(m.status).then(i=>{i==null||i.forEach(n=>{var t;o.value.labels.push((t=n.errorCodeInfo)==null?void 0:t.errorTypeName),o.value.list.push(n.errorCount)})}).finally(()=>{a.value=!1})};return R(()=>m.status,()=>{o.value.list=[],o.value.labels=[],_()}),G(_),(i,n)=>{const t=k("bk-loading");return M(),V(t,{class:"analysis-doughnut overview-card mt20",loading:a.value},{default:S(()=>[h("h3",W,$(e(s)("State by error code")),1),u(e(J),{data:o.value},null,8,["data"])]),_:1},8,["loading"])}}});var Z=w(X,[["__scopeId","data-v-7fe5e370"]]);const ee={class:"g-card-title"},te=E({__name:"analysis-table",props:L,emits:["change"],setup(T,{emit:m}){const s=T,{t:a}=N();j();const{handleChange:o}=F(m),_=g(!1),i=[{label:a("Pipeline"),field:"pipelineName",render({cell:d,row:l}){return q("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){const b=l.projectId,v=l.pipelineId,P=l.buildId,p=l.atomPosition&&l.atomPosition.split("-");let f,y,B,C;p.length===3?(f=p[0],y=p[1],C=p[2]):p.length===4&&(f=p[0],y=p[1],B=p[2],C=p[3]),l.channelCode==="BS"?p.length===3?window.open(`https://${l.domain}/console/pipeline/${b}/${v}/detail/${P}?stageIndex=${f}&containerIndex=${y}&elementIndex=${C}`,"_blank"):window.open(`https://${l.domain}/console/pipeline/${b}/${v}/detail/${P}?stageIndex=${f}&containerIndex=${y}&containerGroupIndex=${B}&elementIndex=${C}`,"_blank"):l.channelCode==="GIT"&&(p.length===3?window.open(`https://${l.domain}/pipeline/${v}/detail/${P}/?page=1&stageIndex=${f}&containerIndex=${y}&elementIndex=${C}#${b.split("_")[1]}`,"_blank"):window.open(`https://${l.domain}/pipeline/${v}/detail/${P}/?page=1&stageIndex=${f}&containerIndex=${y}&containerGroupIndex=${B}&elementIndex=${C}#${b.split("_")[1]}`,"_blank"))}},[d," #",l.buildNum])}},{label:a("Plugin"),field:"atomName"},{label:a("Start Time"),field:"startTime",sort:!0},{label:a("Username"),field:"startUser"},{label:a("Error Type"),field:"errorTypeName"},{label:a("Error Code"),field:"errorCode",sort:!0},{label:a("Error Message"),field:"errorMsg",sort:!0,render({cell:d,row:l}){return q("span",{title:l.errorMsg},[d,l.errorMsg])}}],n=g([]),t=g({current:1,count:0,limit:10}),x=d=>{t.value.current=d,r()},c=d=>{t.value.limit=d,r()},r=()=>{_.value=!0,I.getErrorCodeInfoDetail(s.status,t.value.current,t.value.limit).then(d=>{t.value.count=d.count,n.value=d.records}).finally(()=>{_.value=!1,o(!1)})};return R(()=>s.status,r),G(r),(d,l)=>{const b=k("bk-table"),v=k("bk-loading");return M(),V(v,{class:"overview-card mt20",loading:_.value},{default:S(()=>[h("h3",ee,$(e(a)("Details")),1),u(b,{class:"analysis-table",columns:i,data:n.value,"remote-pagination":"",settings:"",pagination:t.value,onPageValueChange:x,onPageLimitChange:c},null,8,["data","pagination"])]),_:1},8,["loading"])}}});var ae=w(te,[["__scopeId","data-v-14059f18"]]);const ne={class:"header"},le=h("span",{class:"crumbs-icon"}," > ",-1),se={class:"g-content"},pe=E({__name:"fail-analysis-main",setup(T){const{t:m}=N(),s=Y(),a=j(),o=g({pipelineIds:[s.query.pipelineId].filter(c=>c),pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[],atomCodes:[s.query.atomCode].filter(c=>c)}),_=g(s.query.atomCode||""),i=g(!1),n=c=>{i.value=c},t=c=>{i.value=!0,o.value={...o.value,...c}},x=()=>{a.push({name:"PluginRunAnalysis"})};return(c,r)=>{const d=k("bk-alert");return M(),A(z,null,[u(e(U),null,{default:S(()=>[h("div",ne,[h("a",{class:"plugin-trend-title",onClick:x},$(e(m)("Plugin trend")),1),le,h("span",null,$(e(m)("Plugin fail analtysis"))+": "+$(e(s).query.atomCode),1)])]),_:1}),h("main",se,[u(d,{theme:"info",title:e(m)("You can only query the statistics in the last 6 months!")},null,8,["title"]),u(Q,{"reset-btn-disabled":i.value,status:o.value,"atom-code":_.value,onChange:t},null,8,["reset-btn-disabled","status","atom-code"]),u(Z,{status:o.value},null,8,["status"]),u(ae,{status:o.value,"reset-btn-disabled":i.value,onChange:n},null,8,["status","reset-btn-disabled"])])],64)}}});export{pe as default};
