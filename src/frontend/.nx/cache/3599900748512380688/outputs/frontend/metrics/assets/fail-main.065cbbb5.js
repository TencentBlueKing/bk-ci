import{h as b,S as D,u as I,M as j}from"./bk-chart.min.7ef216d8.js";import{d as T,u as C,r as f,o as k,c as L,g as d,e as t,w as $,h as R,t as B,j as g,k as M,l as q,m as x,b as P,y as V,q as w,a as U,F as H}from"./index.c68a50d1.js";import{_ as E}from"./plugin-vue_export-helper.21dcd24c.js";import{d as O}from"./doughnut.9cdefdeb.js";import"./use-color.b34df27b.js";const N={status:Object,resetBtnDisabled:Boolean};const z={class:"main-filter"},A=T({__name:"fail-filter",props:N,emits:["change"],setup(v,{emit:h}){const{t:s}=C(),{handleChange:e,handleTimeChange:c}=I(h),r=()=>{e({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[]})},n=a=>a&&a.getTime()>Date.now();return(a,l)=>{const p=f("bk-date-picker"),_=f("bk-button");return k(),L("section",z,[d(t(D),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:t(s)("Pipelines"),multiple:!0,"api-method":t(b).getPipelineList,"select-value":a.status.pipelineIds,onChange:l[0]||(l[0]=i=>t(e)({pipelineIds:i}))},null,8,["placeholder","api-method","select-value"]),d(t(D),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:t(s)("Error Type"),multiple:!0,"api-method":t(b).getErrorTypeList,"select-value":a.status.errorTypes,onChange:l[1]||(l[1]=i=>t(e)({errorTypes:i}))},null,8,["placeholder","api-method","select-value"]),d(t(D),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:t(s)("Pipeline Lable"),multiple:!0,"api-method":t(b).getPipelineLabels,"select-value":a.status.pipelineLabelIds,onChange:l[2]||(l[2]=i=>t(e)({pipelineLabelIds:i}))},null,8,["placeholder","api-method","select-value"]),d(p,{class:"mr16 w240",type:"daterange","disable-date":n,"model-value":[a.status.startTime,a.status.endTime],onChange:t(c)},null,8,["model-value","onChange"]),d(_,{disabled:a.resetBtnDisabled,onClick:r},{default:$(()=>[R(B(t(s)("Reset")),1)]),_:1},8,["disabled"])])}}});var G=E(A,[["__scopeId","data-v-5343d8ff"]]);const J={class:"g-card-title"},K=T({__name:"error-doughnut",props:N,emits:["change"],setup(v,{emit:h}){const s=v,{t:e}=C(),{handleChange:c}=I(h),r=g(!1),n=g({labels:[],list:[],errorTypes:[]}),a=()=>{r.value=!0,b.getErrorTypeSummaryData(s.status).then(({pipelineFailInfoList:p})=>{p==null||p.forEach(_=>{n.value.list.push(_.errorCount),n.value.labels.push(_.name),n.value.errorTypes.push(_.errorType)})}).finally(()=>{r.value=!1})},l=([{index:p}])=>{n.value.errorTypes.length>1&&c({errorTypes:[n.value.errorTypes[p]]})};return M(()=>s.status,()=>{n.value.list=[],n.value.labels=[],n.value.errorTypes=[],a()}),q(a),(p,_)=>{const i=f("bk-loading");return k(),x(i,{class:"error-doughnut overview-card mt20",loading:r.value},{default:$(()=>[P("h3",J,B(t(e)("Stat by error type")),1),d(t(O),{data:n.value,onDoughnutClick:l},null,8,["data"])]),_:1},8,["loading"])}}});var Q=E(K,[["__scopeId","data-v-492511fa"]]);const W={class:"g-card-title"},X=T({__name:"error-table",props:N,emits:["change"],setup(v,{emit:h}){const s=v,{t:e}=C(),{handleChange:c}=I(h),r=g(!1);V();const n=[{label:e("Pipeline"),field:"pipelineName",render({cell:u,row:o}){return w("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){const m=o.projectId,y=o.pipelineId,S=o.buildId;b.getPipelineType({projectId:m,pipelineId:y}).then(F=>{F.channelCode==="BS"&&window.open(`https://${o.domain}/console/pipeline/${m}/${y}/detail/${S}`,"_blank"),window.open(`https://${o.domain}/pipeline/${y}/detail/${S}/?page=1#${m.split("_")[1]}`,"_blank")})}},[u," #",o.buildNum])}},{label:e("Branch"),field:"branch"},{label:e("Start Time"),field:"startTime"},{label:e("Username"),field:"startUser"},{label:e("Error Type"),field:"errorTypeName"},{label:e("Error Code"),field:"errorCode"},{label:e("Error Message"),field:"errorMsg",render({cell:u,row:o}){return w("span",{title:o.errorMsg},[u,o.errorMsg])}}],a=g([]),l=g({current:1,count:0,limit:10}),p=u=>{l.value.current=u,i()},_=u=>{l.value.limit=u,i()},i=()=>{r.value=!0,b.getPipelineFailDetail(s.status,l.value.current,l.value.limit).then(u=>{var o;l.value.count=u.count,a.value=(o=u.records)==null?void 0:o.map(m=>({...m,...m.pipelineBuildInfo,...m.errorInfo}))}).finally(()=>{r.value=!1,c(!1)})};return M(()=>s.status,i),q(i),(u,o)=>{const m=f("bk-table"),y=f("bk-loading");return k(),x(y,{class:"overview-card mt20",loading:r.value},{default:$(()=>[P("h3",W,B(t(e)("Details")),1),d(m,{class:"error-table",columns:n,data:a.value,"remote-pagination":"",settings:"",pagination:l.value,onPageValueChange:p,onPageLimitChange:_},null,8,["data","pagination"])]),_:1},8,["loading"])}}});var Y=E(X,[["__scopeId","data-v-ee791bf2"]]);const Z={class:"g-content"},ne=T({__name:"fail-main",setup(v){const{t:h}=C(),s=U(),e=g({pipelineIds:[],pipelineLabelIds:[],startTime:s.query.time||"",endTime:s.query.time||"",errorTypes:[]}),c=a=>{r.value=!0,e.value={...e.value,...a}},r=g(!1),n=a=>{r.value=a};return s.query.errorType&&c({errorTypes:[Number(s.query.errorType)]}),(a,l)=>(k(),L(H,null,[d(t(j),{title:t(h)("Fail analysis")},null,8,["title"]),P("main",Z,[d(G,{status:e.value,"reset-btn-disabled":r.value,onChange:c},null,8,["status","reset-btn-disabled"]),d(Q,{status:e.value,onChange:c},null,8,["status"]),d(Y,{"reset-btn-disabled":r.value,status:e.value,onChange:n},null,8,["reset-btn-disabled","status"])])],64))}});export{ne as default};
