import{h as I,u as z,S as V,B as ae,M as se}from"./bk-chart.min.0b6debc5.js";import{i as M,d as le}from"./duration.b4b614d6.js";import{d as L,u as R,j as b,k as N,r as B,o as w,c as x,g as i,w as P,e as a,F as q,bM as ne,h as F,t as T,b as v,f as W,m as O,p as Y,l as Z,x as oe,i as G,y as ie,aq as re,q as J,a as ue}from"./index.b20f0f2b.js";import{s as de}from"./props-type.eada51fa.js";import{_ as H}from"./plugin-vue_export-helper.21dcd24c.js";import{u as Q,E as ce}from"./empty-table-status.e7f78ca9.js";const pe={class:"add-plugin-main"},me={class:"plugin-list"},he={class:"input-icon"},ge={class:"list-main"},_e=["onClick"],ve={class:"use-list"},be={class:"list-header use-header"},fe={class:"list-main"},ye=["onClick"],Ce={class:"add-plugin-footer"},ke=L({__name:"add-plugin",props:de,emits:["change"],setup(S,{emit:f}){const{t:l}=R(),m=f,{handleChange:s}=z(m),n=b(!1),d=b(""),p=b(!1),r=b(!1),t=b(!1);let C=[];const o=b([]),h=b([]),$=()=>{n.value=!n.value},j=()=>{t.value?ne({title:l("\u786E\u8BA4\u79BB\u5F00\u5F53\u524D\u9875\uFF1F"),subTitle:l("\u79BB\u5F00\u5C06\u4F1A\u5BFC\u81F4\u672A\u4FDD\u5B58\u4FE1\u606F\u4E22\u5931"),confirmText:l("\u79BB\u5F00"),onConfirm(){n.value=!n.value,d.value="",t.value=!1},headerAlign:"center",footerAlign:"center",contentAlign:"center"}):(d.value="",n.value=!n.value)},E=()=>{p.value=!0,Promise.all([I.getProjectShowPluginList(),I.getProjectOptionPluginList({keyword:d.value,page:1,pageSize:100})]).then(([c,e])=>{C=[...c.atomBaseInfos],o.value=[...c.atomBaseInfos],[...e.records],h.value=[...e.records]}).finally(()=>{p.value=!1})},U=c=>{t.value=!0,o.value.push(c);const e=h.value.findIndex(u=>u===c);h.value.splice(e,1)},A=c=>{t.value=!0,h.value.push(c);const e=o.value.findIndex(u=>u===c);o.value.splice(e,1)},y=async()=>{try{r.value=!0;const c=[],e=[];C.forEach(u=>{o.value.every(g=>g.atomCode!==u.atomCode)&&e.push(u)}),o.value.forEach(u=>{C.every(g=>u.atomCode!==g.atomCode)&&c.push(u)}),e.length&&await I.deleteProjectPlugin({atomBaseInfos:e}),c.length&&await I.addProjectPlugin({atomBaseInfos:c}),$()}catch(c){console.error(c)}finally{const c=o.value.map(e=>e.atomCode);s({atomCodes:c}),r.value=!1}};return N(d,E),N(n,()=>n.value&&E()),(c,e)=>{const u=B("bk-button"),_=B("bk-input"),g=B("bk-exception"),D=B("bk-loading"),ee=B("bk-sideslider");return w(),x(q,null,[i(u,{onClick:$},{default:P(()=>[i(a(M.exports.Plus),{class:"mr5",width:"22px",height:"22px"}),F(" "+T(a(l)("Add plugin")),1)]),_:1}),i(ee,{class:"add-plugin-slider",width:"640",title:a(l)("Add plugin"),"quick-close":"","before-close":j,isShow:n.value,"onUpdate:isShow":e[2]||(e[2]=k=>n.value=k)},{default:P(()=>[i(D,{class:"add-plugin",loading:p.value},{default:P(()=>[v("section",pe,[v("section",me,[i(_,{class:"list-header",clearable:"",modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=k=>d.value=k),onChange:e[1]||(e[1]=k=>t.value=!0)},{suffix:P(()=>[v("span",he,[i(a(M.exports.Search))])]),_:1},8,["modelValue"]),v("ul",ge,[(w(!0),x(q,null,W(h.value,k=>(w(),x("li",{class:"list-item",key:k.atomCode,onClick:te=>U(k)},[F(T(k.atomName)+" ",1),i(a(M.exports.ArrowsRight),{width:"25px",height:"25px",class:"list-icon"})],8,_e))),128)),h.value.length<=0?(w(),O(g,{key:0,type:"empty",scene:"part"})):Y("",!0)])]),v("section",ve,[v("span",be,T(a(l)("Selected Plugins"))+" \uFF08"+T(o.value.length)+"\uFF09",1),v("ul",fe,[(w(!0),x(q,null,W(o.value,k=>(w(),x("li",{class:"list-item",key:k.atomCode,onClick:te=>A(k)},[F(T(k.atomName)+" ",1),i(a(M.exports.CloseLine),{class:"list-icon"})],8,ye))),128)),o.value.length<=0?(w(),O(g,{key:0,type:"empty",scene:"part"})):Y("",!0)])])]),v("section",Ce,[v("section",null,[i(u,{theme:"primary",class:"mr8",loading:r.value,onClick:y},{default:P(()=>[F(T(a(l)("Submit")),1)]),_:1},8,["loading"]),i(u,{onClick:j},{default:P(()=>[F(T(a(l)("Cancel")),1)]),_:1})])])]),_:1},8,["loading"])]),_:1},8,["title","isShow"])],64)}}});var Te=H(ke,[["__scopeId","data-v-4d576403"]]);const K={status:Object,resetBtnDisabled:Boolean};const we={class:"main-filter mt20"},Pe=L({__name:"analysis-filter",props:K,emits:["change"],setup(S,{emit:f}){const{t:l}=R(),m=f,{handleChange:s,handleTimeChange:n}=z(m),d=()=>{s({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],atomCodes:[]})},p=r=>r&&r.getTime()>Date.now();return(r,t)=>{const C=B("bk-date-picker"),o=B("bk-button");return w(),x("section",we,[i(a(V),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:a(l)("Pipelines"),multiple:!0,"api-method":a(I).getPipelineList,"select-value":r.status.pipelineIds,onChange:t[0]||(t[0]=h=>a(s)({pipelineIds:h}))},null,8,["placeholder","api-method","select-value"]),i(a(V),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:a(l)("Error Type"),multiple:!0,"api-method":a(I).getErrorTypeList,"select-value":r.status.errorTypes,onChange:t[1]||(t[1]=h=>a(s)({errorTypes:h}))},null,8,["placeholder","api-method","select-value"]),i(a(V),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:a(l)("Pipeline Label"),multiple:!0,"api-method":a(I).getPipelineLabels,"select-value":r.status.pipelineLabelIds,onChange:t[2]||(t[2]=h=>a(s)({pipelineLabelIds:h}))},null,8,["placeholder","api-method","select-value"]),i(a(V),{class:"mr8 w240","id-key":"atomCode","name-key":"atomName",placeholder:a(l)("Plugin"),multiple:!0,"api-method":a(I).getProjectPluginList,"select-value":r.status.atomCodes,onChange:t[3]||(t[3]=h=>a(s)({atomCodes:h}))},null,8,["placeholder","api-method","select-value"]),i(C,{class:"mr16 w240",type:"daterange","disable-date":p,"model-value":[r.status.startTime,r.status.endTime],onChange:a(n)},null,8,["model-value","onChange"]),i(o,{disabled:r.resetBtnDisabled,onClick:d},{default:P(()=>[F(T(a(l)("Reset")),1)]),_:1},8,["disabled"])])}}});var Be=H(Pe,[["__scopeId","data-v-491ae000"]]),X=L({props:{data:Array,labels:Array,title:String,type:String},setup(S){const f=Q(.3),l=Q(),m=b(null);let s;const n=()=>{s==null||s.destroy()},d=()=>{n();const{data:p,labels:r,title:t,type:C}=S;s=new ae(m.value,{type:"line",data:{labels:r,datasets:p.map((o,h)=>({label:o.label,backgroundColor:f[h],borderColor:l[h],lineTension:0,borderWidth:2,pointRadius:2,pointHitRadius:3,pointHoverRadius:3,data:[...o.list]}))},options:{maintainAspectRatio:!1,responsive:!0,plugins:{tooltip:{bodySpacing:10,mode:"x",intersect:!1,enableItemActive:!0,singleInRange:!0,callbacks:{title(o){return o[0].label},label(o){return C==="rate"?o.dataset.label+": "+o.raw+"%":o.dataset.label+": "+o.raw+"min"}}},legend:{position:"bottom",legendIcon:"arc",align:"center",labels:{padding:10,usePointStyle:!0,pointStyle:"dash"}},crosshair:{enabled:!0,mode:"x",style:{x:{enabled:!0,color:"#cde0ff",weight:1,borderStyle:"solid"},y:{enabled:!1}}}},scales:{yAxes:{scaleLabel:{display:!0,padding:0},grid:{drawTicks:!1,borderDash:[5,5]},title:{display:!0,text:t,align:"start",color:"#979BA5"},ticks:{padding:10,color:"#979BA5"},min:0},xAxes:{scaleLabel:{display:!0,padding:0},grid:{drawTicks:!1,display:!1},ticks:{padding:10,sampleSize:20,autoSkip:!0,maxRotation:50}}}}})};return N([()=>S.data,()=>S.labels],d),Z(d),oe(n),()=>i("div",{class:"canvas-wrapper"},[i("canvas",{ref:m},null)])}});const Ie={class:"analysis-line overview-card mt20"},Se={class:"g-card-title"},xe={class:"analysis-line overview-card mt20"},Fe={class:"g-card-title"},Le=L({__name:"analysis-lines",props:K,setup(S){const{t:f}=R(),l=S,m=b(!1),s=b({rateTrend:{data:[],labels:[]},timeTrend:{data:[],labels:[]}}),n=()=>{m.value=!0,I.getAtomStatisticsTrendInfo(l.status).then(({atomTrendInfos:d=[]})=>{d==null||d.forEach(p=>{const r=p.atomTrendInfos.map(t=>t.statisticsTime);s.value.rateTrend.data.push({label:p.atomName,list:p.atomTrendInfos.map(t=>t.successRate)}),s.value.rateTrend.labels=r,s.value.timeTrend.data.push({label:p.atomName,list:p.atomTrendInfos.map(t=>t.avgCostTime)}),s.value.timeTrend.labels=r})}).finally(()=>{m.value=!1})};return N(()=>l.status,()=>{s.value.rateTrend.data=[],s.value.rateTrend.labels=[],s.value.timeTrend.data=[],s.value.timeTrend.labels=[],n()}),(d,p)=>{const r=B("bk-loading");return w(),O(r,{class:"analysis-home",loading:m.value},{default:P(()=>[v("section",Ie,[v("h3",Se,T(a(f)("Success rate trend")),1),i(a(X),{data:s.value.rateTrend.data,labels:s.value.rateTrend.labels,title:a(f)("Success rate (%)"),type:"rate"},null,8,["data","labels","title"])]),v("section",xe,[v("h3",Fe,T(a(f)("Average time trend")),1),i(a(X),{data:s.value.timeTrend.data,labels:s.value.timeTrend.labels,title:a(f)("Average time (min)"),type:"time"},null,8,["data","labels","title"])])]),_:1},8,["loading"])}}});var Ae=H(Le,[["__scopeId","data-v-3f9fdbea"]]);const De={class:"g-card-title"},Ne=L({__name:"analysis-table",props:K,emits:["change","clear"],setup(S,{emit:f}){G.extend(le);const{t:l}=R(),m=f,{handleChange:s}=z(m),n=S,d=b(!1),p=b([]),r=b([]),t=b({current:1,count:0,limit:10}),C=ie(),o=y=>{t.value.current=y,p.value=[],A()},h=y=>{t.value.limit=y,p.value=[],A()},$={scm:"SCM",compileBuild:l("\u7F16\u8BD1"),test:l("\u6D4B\u8BD5"),deploy:l("\u7F16\u8BD1"),security:l("\u90E8\u7F72"),common:l("\u5176\u5B83")},j=re(()=>n.status.pipelineIds.length||n.status.pipelineLabelIds.length||n.status.errorTypes.length||n.status.atomCodes.length||n.status.startTime||n.status.endTime?"search-empty":"empty"),E=()=>{m("clear",{pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],atomCodes:[]})},U=y=>{const c=G.duration(y),e=c.hours(),u=c.minutes(),g={s:c.seconds()};return u&&(g.m=u),e&&(g.h=e),g},A=()=>{d.value=!0,I.getAtomStatisticsDetail(n.status,t.value.current,t.value.limit).then(y=>{var c;Object.entries(y.headerInfo).forEach(([e,u])=>{const _={label:u,field:e,showOverflowTooltip:!0,sort:!0};e==="atomCode"&&(_.field="atomName",_.render=({cell:g,row:D})=>J("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){C.push({name:"PluginFailAnalysis",query:{pipelineId:D.pipelineId,atomCode:D.atomCode}})}},[g])),(e==="atomCode"||e==="classifyCode")&&(_.sort=!1),e==="successRate"&&(_.field="successRate",_.render=({cell:g,row:D})=>J("span",{style:{color:g<90?"red":""}},[g,"%"])),p.value.push(_)}),r.value=(c=y.records)==null?void 0:c.map(e=>{e.classifyCode||(e.classifyCode="--");const u=U(e.avgCostTime);let _="";return u.h&&(_+=u.h+"h"),u.m&&(_+=u.m+"m"),u.s&&(_+=u.s+"s"),e.avgCostTime=_||"0",Object.keys(y.headerInfo).forEach(g=>{g.includes("errorCount")&&!e.atomFailInfos[g]&&(e.atomFailInfos[g]=0)}),e.classifyCode=$[e.classifyCode]||e.classifyCode,{...e,...e.atomBaseInfo,...e.atomFailInfos}}),t.value.count=y.count}).finally(()=>{d.value=!1,s(!1)})};return N(()=>n.status,()=>{p.value=[],r.value=[],A()}),(y,c)=>{const e=B("bk-table"),u=B("bk-loading");return w(),O(u,{class:"overview-card mt20",loading:d.value},{default:P(()=>[v("h3",De,T(a(l)("Plugin stat")),1),i(e,{class:"analysis-table",columns:p.value,data:r.value,"remote-pagination":"",settings:"",pagination:t.value,onPageValueChange:o,onPageLimitChange:h},{empty:P(()=>[i(ce,{type:j.value,onClear:E},null,8,["type"])]),_:1},8,["columns","data","pagination"])]),_:1},8,["loading"])}}});var Re=H(Ne,[["__scopeId","data-v-d9b55884"]]);const $e={class:"g-content"},He=L({__name:"run-analysis-main",setup(S){const{t:f}=R(),l=ue(),m=b({pipelineIds:[l.query.pipelineId].filter(t=>t),pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],atomCodes:[]}),s=b(!1),n=t=>{s.value=t},d=t=>{s.value=!0,m.value={...m.value,...t}},p=t=>{d(t)},r=()=>{I.getProjectShowPluginList().then(t=>{const C=t.atomBaseInfos.map(o=>o.atomCode);d({atomCodes:C})})};return Z(()=>{r()}),(t,C)=>{const o=B("bk-alert");return w(),x(q,null,[i(a(se),null,{default:P(()=>[v("span",null,T(a(f)("Plugin trend")),1),i(Te,{onChange:d})]),_:1}),v("main",$e,[i(o,{theme:"info",title:a(f)("You can only query the statistics in the last 6 months!")},null,8,["title"]),i(Be,{"reset-btn-disabled":s.value,status:m.value,onChange:d},null,8,["reset-btn-disabled","status"]),i(Ae,{status:m.value},null,8,["status"]),i(Re,{status:m.value,"reset-btn-disabled":s.value,onChange:n,onClear:p},null,8,["status","reset-btn-disabled"])])],64)}}});export{He as default};
