import{h as I,S as D,u as q,M as U}from"./bk-chart.min.7ef216d8.js";import{s as L}from"./props-type.fc801add.js";import{d as E,u as N,r as k,o as M,c as A,g as d,e,w as S,h as H,t as $,j as h,k as R,l as G,m as V,b as g,y as j,q as F,a as Y,F as z}from"./index.c68a50d1.js";import{_ as w}from"./plugin-vue_export-helper.21dcd24c.js";import{d as J}from"./doughnut.9cdefdeb.js";import"./use-color.b34df27b.js";const K={class:"main-filter mt20"},O=E({__name:"analysis-filter",props:L,emits:["change"],setup(x,{emit:m}){const{t:o}=N(),{handleChange:a,handleTimeChange:s}=q(m),r=()=>{a({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[]})},_=n=>n&&n.getTime()>Date.now();return(n,t)=>{const u=k("bk-date-picker"),T=k("bk-button");return M(),A("section",K,[d(e(D),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:e(o)("Pipelines"),multiple:!0,"api-method":e(I).getPipelineList,"select-value":n.status.pipelineIds,onChange:t[0]||(t[0]=i=>e(a)({pipelineIds:i}))},null,8,["placeholder","api-method","select-value"]),d(e(D),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:e(o)("Error type"),multiple:!0,"api-method":e(I).getErrorTypeList,"select-value":n.status.errorTypes,onChange:t[1]||(t[1]=i=>e(a)({errorTypes:i}))},null,8,["placeholder","api-method","select-value"]),d(e(D),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:e(o)("Pipeline lable"),multiple:!0,"api-method":e(I).getPipelineLabels,"select-value":n.status.pipelineLabelIds,onChange:t[2]||(t[2]=i=>e(a)({pipelineLabelIds:i}))},null,8,["placeholder","api-method","select-value"]),d(e(D),{class:"mr8 w240","id-key":"errorCode","name-key":"errorCode",placeholder:e(o)("Error code"),multiple:!0,"api-method":e(I).getErrorCodeList,"select-value":n.status.errorCodes,onChange:t[3]||(t[3]=i=>e(a)({errorCodes:i}))},null,8,["placeholder","api-method","select-value"]),d(u,{class:"mr16 w240",type:"daterange","disable-date":_,"model-value":[n.status.startTime,n.status.endTime],onChange:e(s)},null,8,["model-value","onChange"]),d(T,{disabled:n.resetBtnDisabled,onClick:r},{default:S(()=>[H($(e(o)("Reset")),1)]),_:1},8,["disabled"])])}}});var Q=w(O,[["__scopeId","data-v-c4ab8d54"]]);const W={class:"g-card-title"},X=E({__name:"analysis-doughnut",props:L,setup(x){const m=x,{t:o}=N(),a=h(!1),s=h({labels:[],list:[]}),r=()=>{a.value=!0,I.getErrorCodeStatisticsInfo(m.status).then(_=>{_==null||_.forEach(n=>{var t;s.value.labels.push((t=n.errorCodeInfo)==null?void 0:t.errorTypeName),s.value.list.push(n.errorCount)})}).finally(()=>{a.value=!1})};return R(()=>m.status,()=>{s.value.list=[],s.value.labels=[],r()}),G(r),(_,n)=>{const t=k("bk-loading");return M(),V(t,{class:"analysis-doughnut overview-card mt20",loading:a.value},{default:S(()=>[g("h3",W,$(e(o)("State by error code")),1),d(e(J),{data:s.value},null,8,["data"])]),_:1},8,["loading"])}}});var Z=w(X,[["__scopeId","data-v-7fe5e370"]]);const ee={class:"g-card-title"},te=E({__name:"analysis-table",props:L,emits:["change"],setup(x,{emit:m}){const o=x,{t:a}=N();j();const{handleChange:s}=q(m),r=h(!1),_=[{label:a("Pipeline"),field:"pipelineName",render({cell:p,row:l}){return F("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){const b=l.projectId,v=l.pipelineId,P=l.buildId,c=l.atomPosition&&l.atomPosition.split("-");let f,y,B,C;c.length===3?(f=c[0],y=c[1],C=c[2]):c.length===4&&(f=c[0],y=c[1],B=c[2],C=c[3]),l.channelCode==="BS"?c.length===3?window.open(`https://${l.domain}/console/pipeline/${b}/${v}/detail/${P}?stageIndex=${f}&containerIndex=${y}&elementIndex=${C}`,"_blank"):window.open(`https://${l.domain}/console/pipeline/${b}/${v}/detail/${P}?stageIndex=${f}&containerIndex=${y}&containerGroupIndex=${B}&elementIndex=${C}`,"_blank"):l.channelCode==="GIT"&&(c.length===3?window.open(`https://${l.domain}/pipeline/${v}/detail/${P}/?page=1&stageIndex=${f}&containerIndex=${y}&elementIndex=${C}#${b.split("_")[1]}`,"_blank"):window.open(`https://${l.domain}/pipeline/${v}/detail/${P}/?page=1&stageIndex=${f}&containerIndex=${y}&containerGroupIndex=${B}&elementIndex=${C}#${b.split("_")[1]}`,"_blank"))}},[p," #",l.buildNum])}},{label:a("Plugin"),field:"atomName"},{label:a("Start Time"),field:"startTime",sort:!0},{label:a("Username"),field:"startUser"},{label:a("Error Type"),field:"errorTypeName"},{label:a("Error Code"),field:"errorCode",sort:!0},{label:a("Error Message"),field:"errorMsg",sort:!0,render({cell:p,row:l}){return F("span",{title:l.errorMsg},[p,l.errorMsg])}}],n=h([]),t=h({current:1,count:0,limit:10}),u=p=>{t.value.current=p,i()},T=p=>{t.value.limit=p,i()},i=()=>{r.value=!0,I.getErrorCodeInfoDetail(o.status,t.value.current,t.value.limit).then(p=>{t.value.count=p.count,n.value=p.records}).finally(()=>{r.value=!1,s(!1)})};return R(()=>o.status,i),G(i),(p,l)=>{const b=k("bk-table"),v=k("bk-loading");return M(),V(v,{class:"overview-card mt20",loading:r.value},{default:S(()=>[g("h3",ee,$(e(a)("Details")),1),d(b,{class:"analysis-table",columns:_,data:n.value,"remote-pagination":"",settings:"",pagination:t.value,onPageValueChange:u,onPageLimitChange:T},null,8,["data","pagination"])]),_:1},8,["loading"])}}});var ae=w(te,[["__scopeId","data-v-14059f18"]]);const ne={class:"header"},le=g("span",{class:"crumbs-icon"}," > ",-1),se={class:"g-content"},ce=E({__name:"fail-analysis-main",setup(x){const{t:m}=N(),o=Y(),a=j(),s=h({pipelineIds:[o.query.pipelineId].filter(u=>u),pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],errorCodes:[],atomCodes:[o.query.atomCode].filter(u=>u)}),r=h(!1),_=u=>{r.value=u},n=u=>{r.value=!0,s.value={...s.value,...u}},t=()=>{a.push({name:"PluginRunAnalysis"})};return(u,T)=>{const i=k("bk-alert");return M(),A(z,null,[d(e(U),null,{default:S(()=>[g("div",ne,[g("a",{class:"plugin-trend-title",onClick:t},$(e(m)("Plugin trend")),1),le,g("span",null,$(e(m)("Plugin fail analtysis"))+": "+$(e(o).query.atomCode),1)])]),_:1}),g("main",se,[d(i,{theme:"info",title:e(m)("You can only query the statistics in the last 6 months!")},null,8,["title"]),d(Q,{"reset-btn-disabled":r.value,status:s.value,onChange:n},null,8,["reset-btn-disabled","status"]),d(Z,{status:s.value},null,8,["status"]),d(ae,{status:s.value,"reset-btn-disabled":r.value,onChange:_},null,8,["status","reset-btn-disabled"])])],64)}}});export{ce as default};
