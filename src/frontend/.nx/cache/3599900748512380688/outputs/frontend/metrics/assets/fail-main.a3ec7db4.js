import{h as b,S as $,u as B,M as V}from"./bk-chart.min.0b6debc5.js";import{d as w,u as I,r as f,o as D,c as q,g as u,e as t,w as k,h as U,t as E,j as v,k as x,l as F,m as M,b as P,y as H,q as O,aq as z,a as A,F as G}from"./index.b20f0f2b.js";import{_ as L}from"./plugin-vue_export-helper.21dcd24c.js";import{d as J}from"./doughnut.c62304fa.js";import{E as K}from"./empty-table-status.e7f78ca9.js";const N={status:Object,resetBtnDisabled:Boolean};const Q={class:"main-filter"},W=w({__name:"fail-filter",props:N,emits:["change"],setup(y,{emit:g}){const{t:r}=I(),a=g,{handleChange:n,handleTimeChange:i}=B(a),o=()=>{n({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[]})},s=e=>e&&e.getTime()>Date.now();return(e,l)=>{const c=f("bk-date-picker"),_=f("bk-button");return D(),q("section",Q,[u(t($),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:t(r)("Pipelines"),multiple:!0,"api-method":t(b).getPipelineList,"select-value":e.status.pipelineIds,onChange:l[0]||(l[0]=m=>t(n)({pipelineIds:m}))},null,8,["placeholder","api-method","select-value"]),u(t($),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:t(r)("Error Type"),multiple:!0,"api-method":t(b).getErrorTypeList,"select-value":e.status.errorTypes,onChange:l[1]||(l[1]=m=>t(n)({errorTypes:m}))},null,8,["placeholder","api-method","select-value"]),u(t($),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:t(r)("Pipeline Label"),multiple:!0,"api-method":t(b).getPipelineLabels,"select-value":e.status.pipelineLabelIds,onChange:l[2]||(l[2]=m=>t(n)({pipelineLabelIds:m}))},null,8,["placeholder","api-method","select-value"]),u(c,{class:"mr16 w240",type:"daterange","disable-date":s,"model-value":[e.status.startTime,e.status.endTime],onChange:t(i)},null,8,["model-value","onChange"]),u(_,{disabled:e.resetBtnDisabled,onClick:o},{default:k(()=>[U(E(t(r)("Reset")),1)]),_:1},8,["disabled"])])}}});var X=L(W,[["__scopeId","data-v-596d0091"]]);const Y={class:"g-card-title"},Z=w({__name:"error-doughnut",props:N,emits:["change"],setup(y,{emit:g}){const{t:r}=I(),a=g,n=y,{handleChange:i}=B(a),o=v(!1),s=v({labels:[],list:[],errorTypes:[]}),e=()=>{o.value=!0,b.getErrorTypeSummaryData(n.status).then(({pipelineFailInfoList:c})=>{c==null||c.forEach(_=>{s.value.list.push(_.errorCount),s.value.labels.push(_.name),s.value.errorTypes.push(_.errorType)})}).finally(()=>{o.value=!1})},l=([{index:c}])=>{s.value.errorTypes.length>1&&i({errorTypes:[s.value.errorTypes[c]]})};return x(()=>n.status,()=>{s.value.list=[],s.value.labels=[],s.value.errorTypes=[],e()}),F(e),(c,_)=>{const m=f("bk-loading");return D(),M(m,{class:"error-doughnut overview-card mt20",loading:o.value},{default:k(()=>[P("h3",Y,E(t(r)("Stat by error type")),1),u(t(J),{data:s.value,onDoughnutClick:l},null,8,["data"])]),_:1},8,["loading"])}}});var ee=L(Z,[["__scopeId","data-v-492511fa"]]);const te={class:"g-card-title"},ae=w({__name:"error-table",props:N,emits:["change","clear"],setup(y,{emit:g}){const r=g,{t:a}=I(),{handleChange:n}=B(r),i=y,o=v(!1);H();const s=[{label:a("Pipeline"),field:"pipelineName",showOverflowTooltip:!0,render({cell:p,row:d}){return O("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){const h=d.projectId,T=d.pipelineId,S=d.buildId;b.getPipelineType({projectId:h,pipelineId:T}).then(R=>{R.channelCode==="BS"&&window.open(`https://${d.domain}/console/pipeline/${h}/${T}/detail/${S}`,"_blank"),window.open(`https://${d.domain}/pipeline/${T}/detail/${S}/?page=1#${h.split("_")[1]}`,"_blank")})}},[p," #",d.buildNum])}},{label:a("Branch"),field:"branch",showOverflowTooltip:!0},{label:a("Start Time"),field:"startTime",showOverflowTooltip:!0},{label:a("Username"),field:"startUser",showOverflowTooltip:!0},{label:a("Error Type"),field:"errorTypeName",showOverflowTooltip:!0},{label:a("Error Code"),field:"errorCode",showOverflowTooltip:!0},{label:a("Error Message"),field:"errorMsg",showOverflowTooltip:!0,render({cell:p,row:d}){return O("span",[p])}}],e=v([]),l=v({current:1,count:0,limit:10}),c=z(()=>i.status.pipelineIds.length||i.status.pipelineLabelIds.length||i.status.errorTypes.length||i.status.startTime||i.status.endTime?"search-empty":"empty"),_=()=>{r("clear",{pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[]})},m=p=>{l.value.current=p,C()},j=p=>{l.value.limit=p,C()},C=()=>{o.value=!0,b.getPipelineFailDetail(i.status,l.value.current,l.value.limit).then(p=>{var d;l.value.count=p.count,e.value=(d=p.records)==null?void 0:d.map(h=>({...h,...h.pipelineBuildInfo,...h.errorInfo}))}).finally(()=>{o.value=!1,n(!1)})};return x(()=>i.status,C),F(C),(p,d)=>{const h=f("bk-table"),T=f("bk-loading");return D(),M(T,{class:"overview-card mt20",loading:o.value},{default:k(()=>[P("h3",te,E(t(a)("Details")),1),u(h,{class:"error-table",columns:s,data:e.value,"remote-pagination":"",settings:"",pagination:l.value,onPageValueChange:m,onPageLimitChange:j},{empty:k(()=>[u(K,{type:c.value,onClear:_},null,8,["type"])]),_:1},8,["data","pagination"])]),_:1},8,["loading"])}}});var le=L(ae,[["__scopeId","data-v-7abfb66d"]]);const se={class:"g-content"},pe=w({__name:"fail-main",setup(y){const{t:g}=I(),r=A(),a=v({pipelineIds:[],pipelineLabelIds:[],startTime:r.query.time||"",endTime:r.query.time||"",errorTypes:[]}),n=e=>{o.value=!0,a.value={...a.value,...e}},i=e=>{n(e)},o=v(!1),s=e=>{o.value=e};return r.query.errorType&&n({errorTypes:[Number(r.query.errorType)]}),(e,l)=>(D(),q(G,null,[u(t(V),{title:t(g)("Fail analysis")},null,8,["title"]),P("main",se,[u(X,{status:a.value,"reset-btn-disabled":o.value,onChange:n},null,8,["status","reset-btn-disabled"]),u(ee,{status:a.value,onChange:n},null,8,["status"]),u(le,{"reset-btn-disabled":o.value,status:a.value,onChange:s,onClear:i},null,8,["reset-btn-disabled","status"])])],64))}});export{pe as default};
