import{h as T,u as O,S as j,B as Z,M as ee}from"./bk-chart.min.7ef216d8.js";import{i as $,d as te}from"./duration.b8812066.js";import{s as ae}from"./props-type.fc801add.js";import{d as A,u as R,j as b,k as N,r as w,o as P,c as I,g as i,w as x,e as t,h as B,t as C,b as v,F as E,f as U,m as V,p as z,l as J,x as se,i as K,y as le,q as W,a as ne}from"./index.c68a50d1.js";import{_ as M}from"./plugin-vue_export-helper.21dcd24c.js";import{u as Y}from"./use-color.b34df27b.js";const oe={class:"add-plugin-main"},ie={class:"plugin-list"},re={class:"input-icon"},ue={class:"list-main"},de=["onClick"],ce={class:"use-list"},pe={class:"list-header use-header"},me={class:"list-main"},_e=["onClick"],he={class:"add-plugin-footer"},ge=A({__name:"add-plugin",props:ae,emits:["change"],setup(S,{emit:f}){const{t:d}=R(),{handleChange:n}=O(f),s=b(!1),_=b(""),c=b(!1),l=b(!1);let a=[];const r=b([]),h=b([]),p=()=>{s.value=!s.value},L=()=>{c.value=!0,Promise.all([T.getProjectShowPluginList(),T.getProjectOptionPluginList({keyword:_.value,page:1,pageSize:100})]).then(([u,e])=>{a=[...u.atomBaseInfos],r.value=[...u.atomBaseInfos],[...e.records],h.value=[...e.records]}).finally(()=>{c.value=!1})},q=u=>{r.value.push(u);const e=h.value.findIndex(o=>o===u);h.value.splice(e,1)},D=u=>{h.value.push(u);const e=r.value.findIndex(o=>o===u);r.value.splice(e,1)},y=async()=>{try{l.value=!0;const u=[],e=[];a.forEach(o=>{r.value.every(m=>m.atomCode!==o.atomCode)&&e.push(o)}),r.value.forEach(o=>{a.every(m=>o.atomCode!==m.atomCode)&&u.push(o)}),e.length&&await T.deleteProjectPlugin({atomBaseInfos:e}),u.length&&await T.addProjectPlugin({atomBaseInfos:u}),p()}catch(u){console.error(u)}finally{const u=r.value.map(e=>e.atomCode);n({atomCodes:u}),l.value=!1}};return N(_,L),N(s,()=>s.value&&L()),(u,e)=>{const o=w("bk-button"),g=w("bk-input"),m=w("bk-exception"),F=w("bk-loading"),Q=w("bk-sideslider");return P(),I(E,null,[i(o,{onClick:p},{default:x(()=>[i(t($.exports.Plus),{class:"mr5",width:"22px",height:"22px"}),B(" "+C(t(d)("Add plugin")),1)]),_:1}),i(Q,{class:"add-plugin-slider",width:"640",title:t(d)("Add plugin"),"quick-close":"",isShow:s.value,"onUpdate:isShow":e[1]||(e[1]=k=>s.value=k)},{default:x(()=>[i(F,{class:"add-plugin",loading:c.value},{default:x(()=>[v("section",oe,[v("section",ie,[i(g,{class:"list-header",clearable:"",modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=k=>_.value=k)},{suffix:x(()=>[v("span",re,[i(t($.exports.Search))])]),_:1},8,["modelValue"]),v("ul",ue,[(P(!0),I(E,null,U(h.value,k=>(P(),I("li",{class:"list-item",key:k.atomCode,onClick:X=>q(k)},[B(C(k.atomName)+" ",1),i(t($.exports.ArrowsRight),{width:"25px",height:"25px",class:"list-icon"})],8,de))),128)),h.value.length<=0?(P(),V(m,{key:0,type:"empty",scene:"part"})):z("",!0)])]),v("section",ce,[v("span",pe,C(t(d)("The selected plugin"))+" \uFF08"+C(r.value.length)+"\uFF09",1),v("ul",me,[(P(!0),I(E,null,U(r.value,k=>(P(),I("li",{class:"list-item",key:k.atomCode,onClick:X=>D(k)},[B(C(k.atomName)+" ",1),i(t($.exports.CloseLine),{class:"list-icon"})],8,_e))),128)),r.value.length<=0?(P(),V(m,{key:0,type:"empty",scene:"part"})):z("",!0)])])]),v("section",he,[v("section",null,[i(o,{theme:"primary",class:"mr8",loading:l.value,onClick:y},{default:x(()=>[B(C(t(d)("Submit")),1)]),_:1},8,["loading"]),i(o,{onClick:p},{default:x(()=>[B(C(t(d)("Cancel")),1)]),_:1})])])]),_:1},8,["loading"])]),_:1},8,["title","isShow"])],64)}}});var ve=M(ge,[["__scopeId","data-v-1d3275d8"]]);const H={status:Object,resetBtnDisabled:Boolean};const be={class:"main-filter mt20"},fe=A({__name:"analysis-filter",props:H,emits:["change"],setup(S,{emit:f}){const{t:d}=R(),{handleChange:n,handleTimeChange:s}=O(f),_=()=>{n({pipelineIds:[],pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],atomCodes:[]})},c=l=>l&&l.getTime()>Date.now();return(l,a)=>{const r=w("bk-date-picker"),h=w("bk-button");return P(),I("section",be,[i(t(j),{class:"mr8 w240","id-key":"pipelineId","name-key":"pipelineName",placeholder:t(d)("Pipelines"),multiple:!0,"api-method":t(T).getPipelineList,"select-value":l.status.pipelineIds,onChange:a[0]||(a[0]=p=>t(n)({pipelineIds:p}))},null,8,["placeholder","api-method","select-value"]),i(t(j),{class:"mr8 w240","id-key":"errorType","name-key":"errorName",placeholder:t(d)("Error Type"),multiple:!0,"api-method":t(T).getErrorTypeList,"select-value":l.status.errorTypes,onChange:a[1]||(a[1]=p=>t(n)({errorTypes:p}))},null,8,["placeholder","api-method","select-value"]),i(t(j),{class:"mr8 w240","id-key":"labelId","name-key":"labelName",placeholder:t(d)("Pipeline Lable"),multiple:!0,"api-method":t(T).getPipelineLabels,"select-value":l.status.pipelineLabelIds,onChange:a[2]||(a[2]=p=>t(n)({pipelineLabelIds:p}))},null,8,["placeholder","api-method","select-value"]),i(t(j),{class:"mr8 w240","id-key":"atomCode","name-key":"atomName",placeholder:t(d)("Plugin"),multiple:!0,"api-method":t(T).getProjectPluginList,"select-value":l.status.atomCodes,onChange:a[3]||(a[3]=p=>t(n)({atomCodes:p}))},null,8,["placeholder","api-method","select-value"]),i(r,{class:"mr16 w240",type:"daterange","disable-date":c,"model-value":[l.status.startTime,l.status.endTime],onChange:t(s)},null,8,["model-value","onChange"]),i(h,{disabled:l.resetBtnDisabled,onClick:_},{default:x(()=>[B(C(t(d)("Reset")),1)]),_:1},8,["disabled"])])}}});var ye=M(fe,[["__scopeId","data-v-7b43f411"]]),G=A({props:{data:Array,labels:Array,title:String,type:String},setup(S){const f=Y(.3),d=Y(),n=b(null);let s;const _=()=>{s==null||s.destroy()},c=()=>{_();const{data:l,labels:a,title:r,type:h}=S;s=new Z(n.value,{type:"line",data:{labels:a,datasets:l.map((p,L)=>({label:p.label,backgroundColor:f[L],borderColor:d[L],lineTension:0,borderWidth:2,pointRadius:2,pointHitRadius:3,pointHoverRadius:3,data:[...p.list]}))},options:{maintainAspectRatio:!1,responsive:!0,plugins:{tooltip:{bodySpacing:10,mode:"x",intersect:!1,enableItemActive:!0,singleInRange:!0,callbacks:{title(p){return p[0].label},label(p){return h==="rate"?p.dataset.label+": "+p.raw+"%":p.dataset.label+": "+p.raw+"min"}}},legend:{position:"bottom",legendIcon:"arc",align:"center",labels:{padding:10,usePointStyle:!0,pointStyle:"dash"}},crosshair:{enabled:!0,mode:"x",style:{x:{enabled:!0,color:"#cde0ff",weight:1,borderStyle:"solid"},y:{enabled:!1}}}},scales:{yAxes:{scaleLabel:{display:!0,padding:0},grid:{drawTicks:!1,borderDash:[5,5]},title:{display:!0,text:r,align:"start",color:"#979BA5"},ticks:{padding:10,color:"#979BA5"},min:0},xAxes:{scaleLabel:{display:!0,padding:0},grid:{drawTicks:!1,display:!1},ticks:{padding:10,sampleSize:20,autoSkip:!0,maxRotation:50}}}}})};return N([()=>S.data,()=>S.labels],c),J(c),se(_),()=>i("div",{class:"canvas-wrapper"},[i("canvas",{ref:n},null)])}});const Ce={class:"analysis-line overview-card mt20"},ke={class:"g-card-title"},Pe={class:"analysis-line overview-card mt20"},we={class:"g-card-title"},Te=A({__name:"analysis-lines",props:H,setup(S){const f=S,{t:d}=R(),n=b(!1),s=b({rateTrend:{data:[],labels:[]},timeTrend:{data:[],labels:[]}}),_=()=>{n.value=!0,T.getAtomStatisticsTrendInfo(f.status).then(({atomTrendInfos:c=[]})=>{c==null||c.forEach(l=>{const a=l.atomTrendInfos.map(r=>r.statisticsTime);s.value.rateTrend.data.push({label:l.atomName,list:l.atomTrendInfos.map(r=>r.successRate)}),s.value.rateTrend.labels=a,s.value.timeTrend.data.push({label:l.atomName,list:l.atomTrendInfos.map(r=>r.avgCostTime)}),s.value.timeTrend.labels=a})}).finally(()=>{n.value=!1})};return N(()=>f.status,()=>{s.value.rateTrend.data=[],s.value.rateTrend.labels=[],s.value.timeTrend.data=[],s.value.timeTrend.labels=[],_()}),(c,l)=>{const a=w("bk-loading");return P(),V(a,{class:"analysis-home",loading:n.value},{default:x(()=>[v("section",Ce,[v("h3",ke,C(t(d)("Success rate trend")),1),i(t(G),{data:s.value.rateTrend.data,labels:s.value.rateTrend.labels,title:t(d)("Success rate (%)"),type:"rate"},null,8,["data","labels","title"])]),v("section",Pe,[v("h3",we,C(t(d)("Average time trend")),1),i(t(G),{data:s.value.timeTrend.data,labels:s.value.timeTrend.labels,title:t(d)("Average time (min)"),type:"time"},null,8,["data","labels","title"])])]),_:1},8,["loading"])}}});var Se=M(Te,[["__scopeId","data-v-3f9fdbea"]]);const xe={class:"g-card-title"},Le=A({__name:"analysis-table",props:H,emits:["change"],setup(S,{emit:f}){const d=S;K.extend(te);const{t:n}=R(),{handleChange:s}=O(f),_=b(!1),c=b([]),l=b([]),a=b({current:1,count:0,limit:10}),r=le(),h=y=>{a.value.current=y,c.value=[],D()},p=y=>{a.value.limit=y,c.value=[],D()},L={scm:"SCM",compileBuild:n("\u7F16\u8BD1"),test:n("\u6D4B\u8BD5"),deploy:n("\u7F16\u8BD1"),security:n("\u90E8\u7F72"),common:n("\u5176\u5B83")},q=y=>{const u=K.duration(y),e=u.hours(),o=u.minutes(),m={s:u.seconds()};return o&&(m.m=o),e&&(m.h=e),m},D=()=>{_.value=!0,T.getAtomStatisticsDetail(d.status,a.value.current,a.value.limit).then(y=>{var u;Object.entries(y.headerInfo).forEach(([e,o])=>{const g={label:o,field:e,sort:!0};e==="atomCode"&&(g.field="atomName",g.render=({cell:m,row:F})=>W("span",{style:{cursor:"pointer",color:"#3a84ff"},onClick(){r.push({name:"PluginFailAnalysis",query:{pipelineId:F.pipelineId,atomCode:F.atomCode}})}},[m])),(e==="atomCode"||e==="classifyCode")&&(g.sort=!1),e==="successRate"&&(g.field="successRate",g.render=({cell:m,row:F})=>W("span",{style:{color:m<90?"red":""}},[m,"%"])),c.value.push(g)}),l.value=(u=y.records)==null?void 0:u.map(e=>{e.classifyCode||(e.classifyCode="--");const o=q(e.avgCostTime);let g="";return o.h&&(g+=o.h+"h"),o.m&&(g+=o.m+"m"),o.s&&(g+=o.s+"s"),e.avgCostTime=g||"0",Object.keys(y.headerInfo).forEach(m=>{m.includes("errorCount")&&!e.atomFailInfos[m]&&(e.atomFailInfos[m]=0)}),e.classifyCode=L[e.classifyCode]||e.classifyCode,{...e,...e.atomBaseInfo,...e.atomFailInfos}}),a.value.count=y.count}).finally(()=>{_.value=!1,s(!1)})};return N(()=>d.status,()=>{c.value=[],l.value=[],D()}),(y,u)=>{const e=w("bk-table"),o=w("bk-loading");return P(),V(o,{class:"overview-card mt20",loading:_.value},{default:x(()=>[v("h3",xe,C(t(n)("Plugin stat")),1),i(e,{class:"analysis-table",columns:c.value,data:l.value,"remote-pagination":"",settings:"",pagination:a.value,onPageValueChange:h,onPageLimitChange:p},null,8,["columns","data","pagination"])]),_:1},8,["loading"])}}});var Ie=M(Le,[["__scopeId","data-v-5189febc"]]);const Be={class:"g-content"},$e=A({__name:"run-analysis-main",setup(S){const{t:f}=R(),d=ne(),n=b({pipelineIds:[d.query.pipelineId].filter(a=>a),pipelineLabelIds:[],startTime:"",endTime:"",errorTypes:[],atomCodes:[]}),s=b(!1),_=a=>{s.value=a},c=a=>{s.value=!0,n.value={...n.value,...a}},l=()=>{T.getProjectShowPluginList().then(a=>{const r=a.atomBaseInfos.map(h=>h.atomCode);c({atomCodes:r})})};return J(()=>{l()}),(a,r)=>{const h=w("bk-alert");return P(),I(E,null,[i(t(ee),null,{default:x(()=>[v("span",null,C(t(f)("Plugin trend")),1),i(ve,{onChange:c})]),_:1}),v("main",Be,[i(h,{theme:"info",title:t(f)("You can only query the statistics in the last 6 months!")},null,8,["title"]),i(ye,{"reset-btn-disabled":s.value,status:n.value,onChange:c},null,8,["reset-btn-disabled","status"]),i(Se,{status:n.value},null,8,["status"]),i(Ie,{status:n.value,"reset-btn-disabled":s.value,onChange:_},null,8,["status","reset-btn-disabled"])])],64)}}});export{$e as default};
