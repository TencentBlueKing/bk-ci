# 离岸开发路径
location ~ /(ms/|)([\w-_]+)/api/desktop/(.*) {
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';
    auth_request /auth/desktop;
    auth_request_set $uid $sent_http_x_devops_uid;
    auth_request_set $bk_token $sent_http_x_devops_bk_token;

    set $access_type 'desktop';
    set $service $2;
    set $path $3;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    proxy_set_header X-DEVOPS-UID $uid;
    proxy_set_header X-DEVOPS-BK-TOKEN $bk_token;
    proxy_set_header X-DEVOPS-BK-TICKET $bk_token;
    proxy_set_header X-DEVOPS-SERVICE-NAME $service;

    # 反向代理到目标ip，端口，路径和参数
    proxy_pass http://$target/api/desktop/$path?$args;
}
