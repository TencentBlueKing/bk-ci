# 外部回调分发(codesvn|codegit|gitlab WEBHOOK)
location ~ /external/scm/(codesvn|codegit|gitlab)/commit {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    set $access_type 'build';
    set $service 'process';
    set $provider $1;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';
    proxy_pass http://$target/api/external/scm/$provider/commit?$args;
}
# 外部code的webhook
location ~ /external/code/hook/(commit|oauth) {
    set $access_type 'build';
    set $service 'code';
    set $provider $1;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    proxy_pass http://$target/api/external/code/hook/$provider?$args;
}
# 第三方构建机安装脚本
location ~ /external/agents/(\w+)/(install|uninstall|agent|jre|upgrader|script_upgrader) {
    set $access_type 'build';
    set $service 'environment';
    set $agentId $1;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    proxy_pass http://$target/api/external/thirdPartyAgent/$agentId/$2?$args;
}

# 外部回调分发(安全加固回调)
location ~ /external/(security|wetest)/callback {
    set $access_type 'build';
    set $service 'process';
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    proxy_pass http://$target/api/external/$1/callback?$args;
}

# gw层服务分发
location ~ /(ms/|)(experience|artifactory)/api/gw/(.*) {
    set $access_type 'gw';
    set $service $2;
    set $path $3;
    set $target '';

    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    # 反向代理到目标ip，端口，路径和参数
    proxy_pass http://$target/api/gw/$path?$args;
}

# config模块的配置
location ~ /(config)/(.*) {
    auth_request /auth/service;
    set $access_type '';
    set $service $1;
    set $path $2;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';
    add_header Cache-Control no-store;


    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    # 反向代理到目标ip，端口，路径和参数
    proxy_pass http://$target/$path?$args;
}


# 获取用户的access_token
location ~ /macosVm/proxy/(.*) {
    auth_request /auth/service;

    set $access_type 'service';
    set $path $1;

    # 设置auth的变量
    include auth.request.set.service.conf;

    set_by_lua_block $target {
        return ngx.var.arg_target
    }
    proxy_pass https://$target/$path?$args;
}

# Macos公共构建机的代理
location = /dispatch-macos/gw/build/macos/startBuild {
    auth_request /auth/build;

    set $access_type 'build';

    # 设置auth的变量
    include auth.request.set.build.conf;

    content_by_lua_block {
        ngx.say('{"agentId": "' .. ngx.var.agentId .. '","secretKey": "' .. ngx.var.secretKey .. '","projectId": "' .. ngx.var.projectId .. '","pipelineId": "' .. ngx.var.pipelineId .. '","buildId": "' .. ngx.var.buildId .. '","vmSeqId": "' .. ngx.var.vmSeqId .. '","systemVersion": "' .. ngx.var.systemVersion .. '","xcodeVersion": "' .. ngx.var.xcodeVersion .. '"}')
    }
}

# Macos公共构建机的代理
location = /ms/dispatch-macos/gw/build/macos/startBuild {
    auth_request /auth/build;

    set $access_type 'build';

    # 设置auth的变量
    include auth.request.set.build.conf;

    content_by_lua_block {
        ngx.say('{"agentId": "' .. ngx.var.agentId .. '","secretKey": "' .. ngx.var.secretKey .. '","projectId": "' .. ngx.var.projectId .. '","pipelineId": "' .. ngx.var.pipelineId .. '","buildId": "' .. ngx.var.buildId .. '","vmSeqId": "' .. ngx.var.vmSeqId .. '","systemVersion": "' .. ngx.var.systemVersion .. '","xcodeVersion": "' .. ngx.var.xcodeVersion .. '"}')
    }
}

# 用户access_token
location ~ /(ms/|)project/api/gw/user/accessToken {
    header_filter_by_lua_file 'conf/lua/cors_filter.lua';

    error_page 401 =302 http://login.o.oa.com/?c_url=http://$host$request_uri;

    auth_request /auth/prebuild;

    set $access_type 'user';

    # 设置auth的变量
    include auth.request.set.user.conf;

    set_by_lua_file $use_https 'conf/lua/set/set_use_https.lua';

    content_by_lua_block {
        if ngx.var.use_https == '1' then
            ngx.redirect("https://"..config.bkci.host..ngx.var.request_uri, 302)
        else
            ngx.say('{"uid": "' .. ngx.var.uid .. '","accessToken": "' .. ngx.var.accessToken .. '","bk_ticket": "' .. ngx.var.bk_token .. '"}')
        end
    }
}
