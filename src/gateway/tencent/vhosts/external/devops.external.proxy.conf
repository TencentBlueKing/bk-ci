
# app的项目logo转发
location ~ ^/images/(.*) {
    proxy_read_timeout 60;
    proxy_connect_timeout 60;
    proxy_send_timeout 60;
    set_by_lua_block $target {
        return config.logoHost
    }
    set $images_path $1;
    set $external_location "1";

    proxy_pass http://$target/$images_path;
    proxy_set_header Host $target;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 用户rtx头像
location ~ ^/avatars/(.*) {
    auth_request /auth/app;
    auth_request_set $uid $sent_http_x_devops_uid;

    proxy_read_timeout 60;
    proxy_connect_timeout 60;
    proxy_send_timeout 60;
    set_by_lua_block $target {
        return config.dcloudHost
    }
    set $external_location "1";
    proxy_pass http://$target/Public/Avatar/$uid.png;
    proxy_set_header Host $target;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# devops_app下载路径
location ~ /app/download/(.*)\.(apk|ipa)$ {
    proxy_connect_timeout 60;
    proxy_read_timeout 1800;
    proxy_send_timeout 1800;

    set $app_name $1;
    set $external_location "1";

    set_by_lua_block $target {
        return config.bkrepo.domain
    }

    # apk需要特殊的content-type
    if ( $uri = /app/download/devops_app.apk ) {
        add_header content-type "application/vnd.android.package-archive;";
    }

    proxy_pass http://$target/generic/bkdevops/static/gw/app/$app_name.$2;
}

# 用户rtx信息
location ~ ^/staffInfo {
    set $external_location "1";
    content_by_lua_file 'conf/lua/content/content_staff_info.lua';
}
