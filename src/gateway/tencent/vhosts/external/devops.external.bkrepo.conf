# 外部访问层服务分发
location ~ ^/(ms/|)bkrepo/api/external/(.*)$ {
    set $access_type 'external';
    set $service "bkrepo";
    set $target '';
    set $path $2;
    access_by_lua_file 'conf/lua/router_srv.lua';

    include set.bkrepo.conf;

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    if ($request_uri ~* ^/(ms/|)bkrepo/api/external/(.*)$) {
        proxy_pass http://$target/$2;
    }

    # 反向代理到目标ip，端口，路径和参数
    # proxy_pass http://$target/api/$path?$args;
}

# 静态文件分发
location ~ ^/(ms/|)bkrepo/api/staticfile/(.*)$ {
    set_by_lua_block $bkrepo_static_domain {
        return config.bkrepo.static_domain
    }

    if ($request_uri ~* ^/(ms/|)bkrepo/api/staticfile/(.*)$) {
        proxy_pass http://$bkrepo_static_domain/$2;
    }
}
