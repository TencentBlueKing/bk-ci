# app 下载
location ~ ^/bkrepo/api/external/repository/api/share/([_a-z][a-zA-Z0-9-_]+)/(pipeline|custom)/(.*)$ {
    set $access_type 'external';
    set $service "bkrepo";
    set $target '';
    set $external_location "1";
    set $path_project_id $1;
    set $path_type $2;
    set $path_tail $3;
    access_by_lua_file 'conf/lua/router_srv.lua';

    include set.bkrepo.conf;

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    proxy_pass http://$target/repository/api/share/$path_project_id/$path_type/$path_tail?$args;
}

# app图标
location ~ ^/bkrepo/api/external/generic/bkdevops/app-icon/(.*)$ {
    set $access_type 'external';
    set $service "bkrepo";
    set $target '';
    set $external_location "1";
    set $path_tail $1;
    access_by_lua_file 'conf/lua/router_srv.lua';

    include set.bkrepo.conf;

    # 设置proxy header的变量
    include proxy.set.header.common.conf;

    proxy_pass http://$target/generic/bkdevops/app-icon/$path_tail?$args;
}

# 静态文件分发
location ~ ^/(ms/|)bkrepo/api/staticfile/(.*)$ {
    set_by_lua_block $bkrepo_static_domain {
        return config.bkrepo.static_domain
    }
    set $external_location "1";

    if ($request_uri ~* ^/(ms/|)bkrepo/api/staticfile/(.*)$) {
        proxy_pass http://$bkrepo_static_domain/$2;
    }
}

# 特殊放通的3个路径(TODO暂时性)
location = /bkrepo/bkci-desktop/public/bkci/win32/x64/bkci-0.3.2-full.nupkg {
    proxy_pass https://bkrepo.woa.com/generic/bkci-desktop/public/bkci/win32/x64/bkci-0.3.2-full.nupkg;
}
location = /bkrepo/bkci-desktop/public/bkci/win32/x64/RELEASES {
    proxy_pass https://bkrepo.woa.com/generic/bkci-desktop/public/bkci/win32/x64/RELEASES;
}

# 蓝盾桌面版下载
location ~ ^/(ms/|)bkrepo/bkci-desktop/public/(.*)$ {
    auth_request /auth/desktop;
    auth_request_set $uid $sent_http_x_devops_uid;
    auth_request_set $bk_token $sent_http_x_devops_bk_token;

    set $path_tail $2;

    error_page 401 /tai-login/$path_tail?$args;

    # 对 Mac 的下载文件做缓存
    set $skip_cache "1";
    if ($request_uri ~* \.nupkg$) {
        set $skip_cache "0";
        add_header X-Proxy-Cache $upstream_cache_status;
    }
    proxy_cache_bypass $skip_cache;
    proxy_cache bk_cache;
    proxy_cache_key $host$uri$args;
    proxy_cache_valid 200 301 5m;
    proxy_buffering on;
    proxy_ignore_headers Cache-Control Expires X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset Set-Cookie Vary;


    proxy_pass https://bkrepo.woa.com/generic/bkci-desktop/public/$path_tail?$args;
}

# 太湖登录跳转
location ~ ^/tai-login/(.*)$ {
    set $path_tail $1;
    return 302 https://login.bkdevops.qq.com/login/?c_url=https://bkdevops.qq.com/bkrepo/bkci-desktop/public/$path_tail?$args;
}
