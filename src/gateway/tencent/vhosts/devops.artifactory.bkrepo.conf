# 构建机层服务分发
location ~ ^/(ms/|)bkrepo/api/build/(.*)$ {
    # 设置auth的变量
    auth_request /auth/build;
    include auth.request.set.build.conf;

    # 路由
    set $access_type 'build';
    set $service "bkrepo";
    set $path $2;
    set $target '';
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include set.bkrepo.conf;
    include proxy.set.header.build.conf;

    # 限速
    proxy_buffering on;
    limit_rate 50m;

    proxy_pass http://$target/$path?$args;
}


# user层服务分发
location ~ ^/(ms/|)bkrepo/api/user/(.*)$ {
    set_by_lua_block $target {
        return config.bkrepo.domain
    }
    rewrite ^/(ms/|)bkrepo/api/user/(.*)$ https://$target/web/$2 redirect;
}

# 微服务层服务分发
location ~ ^/(ms/|)bkrepo/api/service/(.*)$ {
    # 设置auth的变量
    auth_request /auth/service;
    include auth.request.set.service.conf;

    # 路由
    set $access_type 'service';
    set $service "bkrepo";
    set $target '';
    set $path $2;
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include set.bkrepo.conf;
    include proxy.set.header.service.conf;

    # 限速
    proxy_buffering on;
    limit_rate 50m;

    proxy_pass http://$target/$path?$args;
}

# 外部访问层服务分发
location ~ ^/(ms/|)bkrepo/api/external/(.*)$ {
    # 路由
    set $access_type 'external';
    set $service "bkrepo";
    set $target '';
    set $path $2;
    access_by_lua_file 'conf/lua/router_srv.lua';

    # 设置proxy header的变量
    include set.bkrepo.conf;
    include proxy.set.header.common.conf;

    # 限速
    proxy_buffering on;
    limit_rate 50m;

    proxy_pass http://$target/$path?$args;
}
